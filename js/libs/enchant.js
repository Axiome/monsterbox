(function(f,c){if(typeof Object.defineProperty!=="function"){Object.defineProperty=function(k,m,l){if("value" in l){k[m]=l.value;}if("get" in l){k.__defineGetter__(m,l.get);}if("set" in l){k.__defineSetter__(m,l.set);}return k;};}if(typeof Object.defineProperties!=="function"){Object.defineProperties=function(l,k){for(var m in k){if(k.hasOwnProperty(m)){Object.defineProperty(l,m,k[m]);}}return l;};}if(typeof Object.create!=="function"){Object.create=function(k,m){function l(){}l.prototype=k;var n=new l();if(m!=null){Object.defineProperties(n,m);}return n;};}if(typeof Object.getPrototypeOf!=="function"){Object.getPrototypeOf=function(k){return k.__proto__;};}if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(k){var o=this;var l=Array.prototype.slice.call(arguments,1);var n=function(){};var m=function(){var p=l.concat(Array.prototype.slice.call(arguments));return o.apply(this instanceof n?this:k||f,p);};n.prototype=o.prototype;m.prototype=new n();return m;};}f.getTime=(function(){var k;if(f.performance&&f.performance.now){k=Date.now();return function(){return k+f.performance.now();};}else{if(f.performance&&f.performance.webkitNow){k=Date.now();return function(){return k+f.performance.webkitNow();};}else{return Date.now;}}}());f.requestAnimationFrame=f.requestAnimationFrame||f.mozRequestAnimationFrame||f.webkitRequestAnimationFrame||f.msRequestAnimationFrame||(function(){var k=f.getTime();var l=1000/60;return function(n){var m=setTimeout(function(){k=f.getTime();n(k);},Math.max(0,k+l-f.getTime()));return m;};}());var g=function(l){if(l!=null){if(!(l instanceof Array)){l=Array.prototype.slice.call(arguments);}l=l.filter(function(m){return[m].join();});}(function k(p,q){var n=[],o,m;for(var r in p){if(p.hasOwnProperty(r)){if(typeof p[r]==="function"){f[r]=p[r];}else{if(typeof p[r]==="object"&&p[r]!==null&&Object.getPrototypeOf(p[r])===Object.prototype){if(l==null){n.push(r);}else{o=l.indexOf(q+r);if(o!==-1){n.push(r);l.splice(o,1);}}}}}}for(o=0,m=n.length;o<m;o++){k(p[n[o]],q+n[o]+".");}}(g,""));if(g.Class.getInheritanceTree(f.Game).length<=g.Class.getInheritanceTree(f.Core).length){f.Game=f.Core;}if(l!=null&&l.length){throw new Error("Cannot load module: "+l.join(", "));}};f.enchant=g;f.addEventListener("message",function(n,k){try{var l=JSON.parse(n.data);if(l.type==="event"){g.Core.instance.dispatchEvent(new g.Event(l.value));}else{if(l.type==="debug"){switch(l.value){case"start":g.Core.instance.start();break;case"pause":g.Core.instance.pause();break;case"resume":g.Core.instance.resume();break;case"tick":g.Core.instance._tick();break;default:break;}}}}catch(m){}},false);g.Class=function(l,k){return g.Class.create(l,k);};g.Class.create=function(r,o){if(r==null&&o){throw new Error("superclass is undefined (enchant.Class.create)");}else{if(r==null){throw new Error("definition is undefined (enchant.Class.create)");}}if(arguments.length===0){return g.Class.create(Object,o);}else{if(arguments.length===1&&typeof arguments[0]!=="function"){return g.Class.create(Object,arguments[0]);}}for(var q in o){if(o.hasOwnProperty(q)){if(typeof o[q]==="object"&&o[q]!==null&&Object.getPrototypeOf(o[q])===Object.prototype){if(!("enumerable" in o[q])){o[q].enumerable=true;}}else{o[q]={value:o[q],enumerable:true,writable:true};}}}var p=function(){if(this instanceof p){p.prototype.initialize.apply(this,arguments);}else{return new p();}};p.prototype=Object.create(r.prototype,o);p.prototype.constructor=p;if(p.prototype.initialize==null){p.prototype.initialize=function(){r.apply(this,arguments);};}var k=this.getInheritanceTree(r);for(var n=0,m=k.length;n<m;n++){if(typeof k[n]._inherited==="function"){k[n]._inherited(p);break;}}return p;};g.Class.getInheritanceTree=function(n){var k=[];var m=n;var l=m.prototype;while(m!==Object){k.push(m);l=Object.getPrototypeOf(l);m=l.constructor;}return k;};g.ENV={VERSION:"0.8.2",BROWSER:(function(k){if(/Eagle/.test(k)){return"eagle";}else{if(/Opera/.test(k)){return"opera";}else{if(/MSIE|Trident/.test(k)){return"ie";}else{if(/Chrome/.test(k)){return"chrome";}else{if(/(?:Macintosh|Windows).*AppleWebKit/.test(k)){return"safari";}else{if(/(?:iPhone|iPad|iPod).*AppleWebKit/.test(k)){return"mobilesafari";}else{if(/Firefox/.test(k)){return"firefox";}else{if(/Android/.test(k)){return"android";}else{return"";}}}}}}}}}(navigator.userAgent)),VENDOR_PREFIX:(function(){var k=navigator.userAgent;if(k.indexOf("Opera")!==-1){return"O";}else{if(/MSIE|Trident/.test(k)){return"ms";}else{if(k.indexOf("WebKit")!==-1){return"webkit";}else{if(navigator.product==="Gecko"){return"Moz";}else{return"";}}}}}()),TOUCH_ENABLED:(function(){var k=document.createElement("div");k.setAttribute("ontouchstart","return");return typeof k.ontouchstart==="function";}()),RETINA_DISPLAY:(function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&f.devicePixelRatio===2){var k=document.querySelector('meta[name="viewport"]');if(k==null){k=document.createElement("meta");document.head.appendChild(k);}k.setAttribute("content","width=640");return true;}else{return false;}}()),USE_FLASH_SOUND:(function(){var k=navigator.userAgent;var l=navigator.vendor||"";return(location.href.indexOf("http")===0&&k.indexOf("Mobile")===-1&&l.indexOf("Apple")!==-1);}()),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:true,USE_TOUCH_TO_START_SCENE:true,USE_WEBAUDIO:(function(){return location.protocol!=="file:";}()),USE_ANIMATION:true};g.Event=g.Class.create({initialize:function(k){this.type=k;this.target=null;this.x=0;this.y=0;this.localX=0;this.localY=0;},_initPosition:function(m,l){var k=g.Core.instance;this.x=this.localX=(m-k._pageX)/k.scale;this.y=this.localY=(l-k._pageY)/k.scale;}});g.Event.LOAD="load";g.Event.ERROR="error";g.Event.CORE_RESIZE="coreresize";g.Event.PROGRESS="progress";g.Event.ENTER_FRAME="enterframe";g.Event.EXIT_FRAME="exitframe";g.Event.ENTER="enter";g.Event.EXIT="exit";g.Event.CHILD_ADDED="childadded";g.Event.ADDED="added";g.Event.ADDED_TO_SCENE="addedtoscene";g.Event.CHILD_REMOVED="childremoved";g.Event.REMOVED="removed";g.Event.REMOVED_FROM_SCENE="removedfromscene";g.Event.TOUCH_START="touchstart";g.Event.TOUCH_MOVE="touchmove";g.Event.TOUCH_END="touchend";g.Event.RENDER="render";g.Event.INPUT_START="inputstart";g.Event.INPUT_CHANGE="inputchange";g.Event.INPUT_END="inputend";g.Event.INPUT_STATE_CHANGED="inputstatechanged";g.Event.LEFT_BUTTON_DOWN="leftbuttondown";g.Event.LEFT_BUTTON_UP="leftbuttonup";g.Event.RIGHT_BUTTON_DOWN="rightbuttondown";g.Event.RIGHT_BUTTON_UP="rightbuttonup";g.Event.UP_BUTTON_DOWN="upbuttondown";g.Event.UP_BUTTON_UP="upbuttonup";g.Event.DOWN_BUTTON_DOWN="downbuttondown";g.Event.DOWN_BUTTON_UP="downbuttonup";g.Event.A_BUTTON_DOWN="abuttondown";g.Event.A_BUTTON_UP="abuttonup";g.Event.B_BUTTON_DOWN="bbuttondown";g.Event.B_BUTTON_UP="bbuttonup";g.Event.ADDED_TO_TIMELINE="addedtotimeline";g.Event.REMOVED_FROM_TIMELINE="removedfromtimeline";g.Event.ACTION_START="actionstart";g.Event.ACTION_END="actionend";g.Event.ACTION_TICK="actiontick";g.Event.ACTION_ADDED="actionadded";g.Event.ACTION_REMOVED="actionremoved";g.Event.ANIMATION_END="animationend";g.EventTarget=g.Class.create({initialize:function(){this._listeners={};},addEventListener:function(l,m){var k=this._listeners[l];if(k==null){this._listeners[l]=[m];}else{if(k.indexOf(m)===-1){k.unshift(m);}}},on:function(){this.addEventListener.apply(this,arguments);},removeEventListener:function(m,n){var l=this._listeners[m];if(l!=null){var k=l.indexOf(n);if(k!==-1){l.splice(k,1);}}},clearEventListener:function(k){if(k!=null){delete this._listeners[k];}else{this._listeners={};}},dispatchEvent:function(n){n.target=this;n.localX=n.x-this._offsetX;n.localY=n.y-this._offsetY;if(this["on"+n.type]!=null){this["on"+n.type](n);}var m=this._listeners[n.type];if(m!=null){m=m.slice();for(var l=0,k=m.length;l<k;l++){m[l].call(this,n);}}}});(function(){var k;g.Core=g.Class.create(g.EventTarget,{initialize:function(o,x){if(f.document.body===null){throw new Error("document.body is null. Please excute 'new Core()' in window.onload.");}g.EventTarget.call(this);var u=true;if(k){u=false;k.stop();}k=g.Core.instance=this;this._calledTime=0;this._mousedownID=0;this._surfaceID=0;this._soundID=0;this._scenes=[];o=o||320;x=x||320;var v=document.getElementById("enchant-stage");var r,p,t;if(!v){v=document.createElement("div");v.id="enchant-stage";v.style.position="absolute";if(document.body.firstChild){document.body.insertBefore(v,document.body.firstChild);}else{document.body.appendChild(v);}r=Math.min(f.innerWidth/o,f.innerHeight/x);this._pageX=v.getBoundingClientRect().left;this._pageY=v.getBoundingClientRect().top;}else{var n=f.getComputedStyle(v);p=parseInt(n.width,10);t=parseInt(n.height,10);if(p&&t){r=Math.min(p/o,t/x);}else{r=1;}while(v.firstChild){v.removeChild(v.firstChild);}v.style.position="relative";var m=v.getBoundingClientRect();this._pageX=Math.round(f.scrollX||f.pageXOffset+m.left);this._pageY=Math.round(f.scrollY||f.pageYOffset+m.top);}v.style.fontSize="12px";v.style.webkitTextSizeAdjust="none";v.style.webkitTapHighlightColor="rgba(0, 0, 0, 0)";this._element=v;this.addEventListener("coreresize",this._oncoreresize);this._width=o;this._height=x;this.scale=r;this.fps=30;this.frame=0;this.ready=false;this.running=false;this.assets={};var s=this._assets=[];(function q(y){if(y.assets){g.Core.instance.preload(y.assets);}for(var z in y){if(y.hasOwnProperty(z)){if(typeof y[z]==="object"&&y[z]!==null&&Object.getPrototypeOf(y[z])===Object.prototype){q(y[z]);}}}}(g));this.currentScene=null;this.rootScene=new g.Scene();this.pushScene(this.rootScene);this.loadingScene=new g.LoadingScene();this._activated=false;this._offsetX=0;this._offsetY=0;this.input={};this.keyboardInputManager=new g.KeyboardInputManager(f.document,this.input);this.keyboardInputManager.addBroadcastTarget(this);this._keybind=this.keyboardInputManager._binds;if(!g.ENV.KEY_BIND_TABLE){g.ENV.KEY_BIND_TABLE={};}for(var l in g.ENV.KEY_BIND_TABLE){this.keybind(l,g.ENV.KEY_BIND_TABLE[l]);}if(u){v=g.Core.instance._element;var w;document.addEventListener("keydown",function(y){k.dispatchEvent(new g.Event("keydown"));if(g.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(y.keyCode)!==-1){y.preventDefault();y.stopPropagation();}},true);if(g.ENV.TOUCH_ENABLED){v.addEventListener("touchstart",function(z){var y=(z.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(y)===-1){z.preventDefault();if(!k.running){z.stopPropagation();}}},true);v.addEventListener("touchmove",function(z){var y=(z.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(y)===-1){z.preventDefault();if(!k.running){z.stopPropagation();}}},true);v.addEventListener("touchend",function(z){var y=(z.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(y)===-1){z.preventDefault();if(!k.running){z.stopPropagation();}}},true);}v.addEventListener("mousedown",function(z){var y=(z.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(y)===-1){z.preventDefault();k._mousedownID++;if(!k.running){z.stopPropagation();}}},true);v.addEventListener("mousemove",function(z){var y=(z.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(y)===-1){z.preventDefault();if(!k.running){z.stopPropagation();}}},true);v.addEventListener("mouseup",function(z){var y=(z.target.tagName).toLowerCase();if(g.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(y)===-1){z.preventDefault();if(!k.running){z.stopPropagation();}}},true);k._touchEventTarget={};if(g.ENV.TOUCH_ENABLED){v.addEventListener("touchstart",function(E){var A=g.Core.instance;var z=new g.Event(g.Event.TOUCH_START);var D=E.changedTouches;var F,C;for(var B=0,y=D.length;B<y;B++){F=D[B];z._initPosition(F.pageX,F.pageY);C=A.currentScene._determineEventTarget(z);A._touchEventTarget[F.identifier]=C;C.dispatchEvent(z);}},false);v.addEventListener("touchmove",function(E){var A=g.Core.instance;var z=new g.Event(g.Event.TOUCH_MOVE);var D=E.changedTouches;var F,C;for(var B=0,y=D.length;B<y;B++){F=D[B];C=A._touchEventTarget[F.identifier];if(C){z._initPosition(F.pageX,F.pageY);C.dispatchEvent(z);}}},false);v.addEventListener("touchend",function(E){var A=g.Core.instance;var z=new g.Event(g.Event.TOUCH_END);var D=E.changedTouches;var F,C;for(var B=0,y=D.length;B<y;B++){F=D[B];C=A._touchEventTarget[F.identifier];if(C){z._initPosition(F.pageX,F.pageY);C.dispatchEvent(z);delete A._touchEventTarget[F.identifier];}}},false);}v.addEventListener("mousedown",function(B){var z=g.Core.instance;var y=new g.Event(g.Event.TOUCH_START);y._initPosition(B.pageX,B.pageY);var A=z.currentScene._determineEventTarget(y);z._touchEventTarget[z._mousedownID]=A;A.dispatchEvent(y);},false);v.addEventListener("mousemove",function(B){var z=g.Core.instance;var y=new g.Event(g.Event.TOUCH_MOVE);y._initPosition(B.pageX,B.pageY);var A=z._touchEventTarget[z._mousedownID];if(A){A.dispatchEvent(y);}},false);v.addEventListener("mouseup",function(B){var z=g.Core.instance;var y=new g.Event(g.Event.TOUCH_END);y._initPosition(B.pageX,B.pageY);var A=z._touchEventTarget[z._mousedownID];if(A){A.dispatchEvent(y);}delete z._touchEventTarget[z._mousedownID];},false);}},width:{get:function(){return this._width;},set:function(l){this._width=l;this._dispatchCoreResizeEvent();}},height:{get:function(){return this._height;},set:function(l){this._height=l;this._dispatchCoreResizeEvent();}},scale:{get:function(){return this._scale;},set:function(l){this._scale=l;this._dispatchCoreResizeEvent();}},_dispatchCoreResizeEvent:function(){var l=new g.Event("coreresize");l.width=this._width;l.height=this._height;l.scale=this._scale;this.dispatchEvent(l);},_oncoreresize:function(p){this._element.style.width=Math.floor(this._width*this._scale)+"px";this._element.style.height=Math.floor(this._height*this._scale)+"px";var o;for(var n=0,m=this._scenes.length;n<m;n++){o=this._scenes[n];o.dispatchEvent(p);}},preload:function(n){var l;if(!(n instanceof Array)){if(typeof n==="object"){l=[];for(var m in n){if(n.hasOwnProperty(m)){l.push([n[m],m]);}}n=l;}else{n=Array.prototype.slice.call(arguments);}}Array.prototype.push.apply(this._assets,n);return this;},load:function(q,n,r,l){var p;if(typeof arguments[1]==="string"){p=n;r=r||function(){};l=l||function(){};}else{p=q;var m=r;r=arguments[1]||function(){};l=m||function(){};}var o=g.Core.findExt(q);return g.Deferred.next(function(){var v=new g.Deferred();var s=function(w){v.call(w);r.call(this,w);};var u=function(w){v.fail(w);l.call(this,w);};if(g.Core._loadFuncs[o]){g.Core.instance.assets[p]=g.Core._loadFuncs[o](q,o,s,u);}else{var t=new XMLHttpRequest();t.open("GET",q,true);t.onreadystatechange=function(){if(t.readyState===4){if(t.status!==200&&t.status!==0){var x=new g.Event("error");x.message=t.status+": Cannot load an asset: "+q;u.call(g.Core.instance,x);}var w=t.getResponseHeader("Content-Type")||"";if(w.match(/^image/)){k.assets[p]=g.Surface.load(q,s,u);}else{if(w.match(/^audio/)){k.assets[p]=g.Sound.load(q,w,s,u);}else{k.assets[p]=t.responseText;s.call(g.Core.instance,new g.Event("load"));}}}};t.send(null);}return v;});},start:function(l){var o=function(){this.frame=0;this.removeEventListener("load",o);};this.addEventListener("load",o);this.currentTime=f.getTime();this.running=true;this.ready=true;if(!this._activated){this._activated=true;if(g.ENV.BROWSER==="mobilesafari"&&g.ENV.USE_WEBAUDIO&&g.ENV.USE_TOUCH_TO_START_SCENE){var q=new g.Deferred();var p=this._createTouchToStartScene();p.addEventListener(g.Event.TOUCH_START,function n(){this.removeEventListener(g.Event.TOUCH_START,n);var r=new g.WebAudioSound();r.buffer=g.WebAudioSound.audioContext.createBuffer(1,1,48000);r.play();k.removeScene(p);k.start(q);},false);k.pushScene(p);return q;}}this._requestNextFrame(0);var m=this._requestPreload().next(function(){g.Core.instance.loadingScene.dispatchEvent(new g.Event(g.Event.LOAD));});if(l){m.next(function(r){l.call(r);}).error(function(r){l.fail(r);});}return m;},_requestPreload:function(){var n={};var m=0,l=0,p=function(){var o=new g.Event("progress");o.loaded=++m;o.total=l;k.loadingScene.dispatchEvent(o);};this._assets.reverse().forEach(function(q){var r,o;if(q instanceof Array){r=q[0];o=q[1];}else{r=o=q;}if(!n[o]){n[o]=this.load(r,o,p);l++;}},this);this.pushScene(this.loadingScene);return g.Deferred.parallel(n);},_createTouchToStartScene:function(){var l=new g.Label("Touch to Start"),m=Math.round(k.width/10),n=new g.Scene();l.color="#fff";l.font=(m-1)+"px bold Helvetica,Arial,sans-serif";l.textAlign="center";l.width=k.width;l.height=l._boundHeight;l.y=(k.height-l.height)/2;n.backgroundColor="#000";n.addChild(l);return n;},debug:function(){this._debug=true;return this.start();},actualFps:{get:function(){return this._actualFps||this.fps;}},_requestNextFrame:function(l){if(!this.ready){return;}if(this.fps>=60||l<=16){this._calledTime=f.getTime();f.requestAnimationFrame(this._callTick);}else{setTimeout(function(){var m=g.Core.instance;m._calledTime=f.getTime();f.requestAnimationFrame(m._callTick);},Math.max(0,l));}},_callTick:function(l){g.Core.instance._tick(l);},_tick:function(r){var q=new g.Event("enterframe");var o=f.getTime();var l=q.elapsed=o-this.currentTime;this._actualFps=l>0?(1000/l):0;var m=this.currentScene.childNodes.slice();var n=Array.prototype.push;while(m.length){var p=m.pop();p.age++;p.dispatchEvent(q);if(p.childNodes){n.apply(m,p.childNodes);}}this.currentScene.age++;this.currentScene.dispatchEvent(q);this.dispatchEvent(q);this.dispatchEvent(new g.Event("exitframe"));this.frame++;o=f.getTime();this.currentTime=o;this._requestNextFrame(1000/this.fps-(o-this._calledTime));},getTime:function(){return f.getTime();},stop:function(){this.ready=false;this.running=false;},pause:function(){this.ready=false;},resume:function(){if(this.ready){return;}this.currentTime=f.getTime();this.ready=true;this.running=true;this._requestNextFrame(0);},pushScene:function(l){this._element.appendChild(l._element);if(this.currentScene){this.currentScene.dispatchEvent(new g.Event("exit"));}this.currentScene=l;this.currentScene.dispatchEvent(new g.Event("enter"));return this._scenes.push(l);},popScene:function(){if(this.currentScene===this.rootScene){return this.currentScene;}this._element.removeChild(this.currentScene._element);this.currentScene.dispatchEvent(new g.Event("exit"));this.currentScene=this._scenes[this._scenes.length-2];this.currentScene.dispatchEvent(new g.Event("enter"));return this._scenes.pop();},replaceScene:function(l){this.popScene();return this.pushScene(l);},removeScene:function(m){if(this.currentScene===m){return this.popScene();}else{var l=this._scenes.indexOf(m);if(l!==-1){this._scenes.splice(l,1);this._element.removeChild(m._element);return m;}else{return null;}}},_buttonListener:function(l){this.currentScene.dispatchEvent(l);},keybind:function(m,l){this.keyboardInputManager.keybind(m,l);this.addEventListener(l+"buttondown",this._buttonListener);this.addEventListener(l+"buttonup",this._buttonListener);return this;},keyunbind:function(m){var l=this._keybind[m];this.keyboardInputManager.keyunbind(m);this.removeEventListener(l+"buttondown",this._buttonListener);this.removeEventListener(l+"buttonup",this._buttonListener);return this;},changeButtonState:function(m,l){this.keyboardInputManager.changeState(m,l);},getElapsedTime:function(){return this.frame/this.fps;}});g.Core._loadFuncs={};g.Core._loadFuncs.jpg=g.Core._loadFuncs.jpeg=g.Core._loadFuncs.gif=g.Core._loadFuncs.png=g.Core._loadFuncs.bmp=function(n,m,o,l){return g.Surface.load(n,o,l);};g.Core._loadFuncs.mp3=g.Core._loadFuncs.aac=g.Core._loadFuncs.m4a=g.Core._loadFuncs.wav=g.Core._loadFuncs.ogg=function(n,m,o,l){return g.Sound.load(n,"audio/"+m,o,l);};g.Core.findExt=function(m){var l=m.match(/\.\w+$/);if(l&&l.length>0){return l[0].slice(1).toLowerCase();}if(m.indexOf("data:")===0){return m.split(/[\/;]/)[1].toLowerCase();}return null;};g.Core.instance=null;}());g.Game=g.Core;g.InputManager=g.Class.create(g.EventTarget,{initialize:function(l,k){g.EventTarget.call(this);this.broadcastTarget=[];this.valueStore=l;this.source=k||this;this._binds={};this._stateHandler=function(n){var o=n.source.identifier;var m=this._binds[o];this.changeState(m,n.data);}.bind(this);},bind:function(k,l){k.addEventListener(g.Event.INPUT_STATE_CHANGED,this._stateHandler);this._binds[k.identifier]=l;},unbind:function(k){k.removeEventListener(g.Event.INPUT_STATE_CHANGED,this._stateHandler);delete this._binds[k.identifier];},addBroadcastTarget:function(l){var k=this.broadcastTarget.indexOf(l);if(k===-1){this.broadcastTarget.push(l);}},removeBroadcastTarget:function(l){var k=this.broadcastTarget.indexOf(l);if(k!==-1){this.broadcastTarget.splice(k,1);}},broadcastEvent:function(o){var n=this.broadcastTarget;for(var m=0,k=n.length;m<k;m++){n[m].dispatchEvent(o);}},changeState:function(k,l){}});g.InputSource=g.Class.create(g.EventTarget,{initialize:function(k){g.EventTarget.call(this);this.identifier=k;},notifyStateChange:function(k){var l=new g.Event(g.Event.INPUT_STATE_CHANGED);l.data=k;l.source=this;this.dispatchEvent(l);}});g.BinaryInputManager=g.Class.create(g.InputManager,{initialize:function(m,l,k,n){g.InputManager.call(this,m,n);this.activeInputsNum=0;this.activeEventNameSuffix=l;this.inactiveEventNameSuffix=k;},bind:function(l,k){g.InputManager.prototype.bind.call(this,l,k);this.valueStore[k]=false;},unbind:function(l){var k=this._binds[l.identifier];g.InputManager.prototype.unbind.call(this,l);delete this.valueStore[k];},changeState:function(l,k){if(k){this._down(l);}else{this._up(l);}},_down:function(k){var m;if(!this.valueStore[k]){this.valueStore[k]=true;m=new g.Event((this.activeInputsNum++)?"inputchange":"inputstart");m.source=this.source;this.broadcastEvent(m);}var l=new g.Event(k+this.activeEventNameSuffix);l.source=this.source;this.broadcastEvent(l);},_up:function(l){var m;if(this.valueStore[l]){this.valueStore[l]=false;m=new g.Event((--this.activeInputsNum)?"inputchange":"inputend");m.source=this.source;this.broadcastEvent(m);}var k=new g.Event(l+this.inactiveEventNameSuffix);k.source=this.source;this.broadcastEvent(k);}});g.BinaryInputSource=g.Class.create(g.InputSource,{initialize:function(k){g.InputSource.call(this,k);}});g.KeyboardInputManager=g.Class.create(g.BinaryInputManager,{initialize:function(l,k){g.BinaryInputManager.call(this,k,"buttondown","buttonup");this._attachDOMEvent(l,"keydown",true);this._attachDOMEvent(l,"keyup",false);},keybind:function(l,k){this.bind(g.KeyboardInputSource.getByKeyCode(""+l),k);},keyunbind:function(k){this.unbind(g.KeyboardInputSource.getByKeyCode(""+k));},_attachDOMEvent:function(m,k,l){m.addEventListener(k,function(q){var n=g.Core.instance;if(!n||!n.running){return;}var o=q.keyCode;var p=g.KeyboardInputSource._instances[o];if(p){p.notifyStateChange(l);}},true);}});g.KeyboardInputSource=g.Class.create(g.BinaryInputSource,{initialize:function(k){g.BinaryInputSource.call(this,k);}});g.KeyboardInputSource._instances={};g.KeyboardInputSource.getByKeyCode=function(k){if(!this._instances[k]){this._instances[k]=new g.KeyboardInputSource(k);}return this._instances[k];};g.Node=g.Class.create(g.EventTarget,{initialize:function(){g.EventTarget.call(this);this._dirty=false;this._matrix=[1,0,0,1,0,0];this._x=0;this._y=0;this._offsetX=0;this._offsetY=0;this.age=0;this.parentNode=null;this.scene=null;this.addEventListener("touchstart",function(k){if(this.parentNode){this.parentNode.dispatchEvent(k);}});this.addEventListener("touchmove",function(k){if(this.parentNode){this.parentNode.dispatchEvent(k);}});this.addEventListener("touchend",function(k){if(this.parentNode){this.parentNode.dispatchEvent(k);}});if(g.ENV.USE_ANIMATION){this.tl=new g.Timeline(this);}},moveTo:function(k,l){this._x=k;this._y=l;this._dirty=true;},moveBy:function(k,l){this._x+=k;this._y+=l;this._dirty=true;},x:{get:function(){return this._x;},set:function(k){this._x=k;this._dirty=true;}},y:{get:function(){return this._y;},set:function(k){this._y=k;this._dirty=true;}},_updateCoordinate:function(){var o=this;var x=[o];var u=o.parentNode;var r=this.scene;while(u&&o._dirty){x.unshift(u);o=o.parentNode;u=o.parentNode;}var t=g.Matrix.instance;var s=t.stack;var w=[];var v,m,k;s.push(x[0]._matrix);for(var q=1,p=x.length;q<p;q++){o=x[q];v=[];t.makeTransformMatrix(o,w);t.multiply(s[s.length-1],w,v);o._matrix=v;s.push(v);m=(typeof o._originX==="number")?o._originX:o._width/2||0;k=(typeof o._originY==="number")?o._originY:o._height/2||0;var n=[m,k];t.multiplyVec(v,n,n);o._offsetX=n[0]-m;o._offsetY=n[1]-k;o._dirty=false;}t.reset();},remove:function(){if(this._listener){this.clearEventListener();}if(this.parentNode){this.parentNode.removeChild(this);}}});var i=function(n,k){var o=[];var q;for(var p=0,m=n.collection.length;p<m;p++){q=n.collection[p];if(k._intersectOne(q)){o.push(q);}}return o;};var j=function(r,q){var s=[];var o,m;for(var p=0,k=r.collection.length;p<k;p++){o=r.collection[p];for(var n=0,t=q.collection.length;n<t;n++){m=q.collection[n];if(o._intersectOne(m)){s.push([o,m]);}}}return s;};var e=function(n,k){var o=[];var q;for(var p=0,m=n.collection.length;p<m;p++){q=n.collection[p];if(k._intersectStrictOne(q)){o.push(q);}}return o;};var h=function(r,q){var s=[];var o,m;for(var p=0,k=r.collection.length;p<k;p++){o=r.collection[p];for(var n=0,t=q.collection.length;n<t;n++){m=q.collection[n];if(o._intersectStrictOne(m)){s.push([o,m]);}}}return s;};var d=function(k){if(k instanceof g.Entity){return i(this,k);}else{if(typeof k==="function"&&k.collection){return j(this,k);}}return false;};var a=function(k){if(k instanceof g.Entity){return e(this,k);}else{if(typeof k==="function"&&k.collection){return h(this,k);}}return false;};g.Entity=g.Class.create(g.Node,{initialize:function(){var k=g.Core.instance;g.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._touchEnabled=true;this._clipping=false;this._originX=null;this._originY=null;this._width=0;this._height=0;this._backgroundColor=null;this._debugColor="#0000ff";this._opacity=1;this._visible=true;this._buttonMode=null;this._style={};this.__styleStatus={};this._isContainedInCollection=false;this.compositeOperation=null;this.buttonMode=null;this.buttonPressed=false;this.addEventListener("touchstart",function(){if(!this.buttonMode){return;}this.buttonPressed=true;this.dispatchEvent(new g.Event(this.buttonMode+"buttondown"));k.changeButtonState(this.buttonMode,true);});this.addEventListener("touchend",function(){if(!this.buttonMode){return;}this.buttonPressed=false;this.dispatchEvent(new g.Event(this.buttonMode+"buttonup"));k.changeButtonState(this.buttonMode,false);});this.enableCollection();},width:{get:function(){return this._width;},set:function(k){this._width=k;this._dirty=true;}},height:{get:function(){return this._height;},set:function(k){this._height=k;this._dirty=true;}},backgroundColor:{get:function(){return this._backgroundColor;},set:function(k){this._backgroundColor=k;}},debugColor:{get:function(){return this._debugColor;},set:function(k){this._debugColor=k;}},opacity:{get:function(){return this._opacity;},set:function(k){this._opacity=parseFloat(k);}},visible:{get:function(){return this._visible;},set:function(k){this._visible=k;}},touchEnabled:{get:function(){return this._touchEnabled;},set:function(k){this._touchEnabled=k;if(k){this._style.pointerEvents="all";}else{this._style.pointerEvents="none";}}},intersect:function(k){if(k instanceof g.Entity){return this._intersectOne(k);}else{if(typeof k==="function"&&k.collection){return i(k,this);}}return false;},_intersectOne:function(k){if(this._dirty){this._updateCoordinate();}if(k._dirty){k._updateCoordinate();}return this._offsetX<k._offsetX+k.width&&k._offsetX<this._offsetX+this.width&&this._offsetY<k._offsetY+k.height&&k._offsetY<this._offsetY+this.height;},intersectStrict:function(k){if(k instanceof g.Entity){return this._intersectStrictOne(k);}else{if(typeof k==="function"&&k.collection){return e(k,this);}}return false;},_intersectStrictOne:function(m){if(this._dirty){this._updateCoordinate();}if(m._dirty){m._updateCoordinate();}var P=this.getOrientedBoundingRect(),N=m.getOrientedBoundingRect(),q=P.leftTop,Q=P.rightTop,au=P.leftBottom,E=P.rightBottom,p=N.leftTop,O=N.rightTop,at=N.leftBottom,D=N.rightBottom,z=q[0],ao=q[1],ae=Q[0],K=Q[1],G=au[0],ar=au[1],ai=E[0],S=E[1],w=p[0],an=p[1],ad=O[0],J=O[1],F=at[0],aq=at[1],ah=D[0],R=D[1],ac=[ae-z,K-ao],C=[ai-ae,S-K],W=[G-ai,ar-S],A=[z-G,ao-ar],ab=[ad-w,J-an],B=[ah-ad,R-J],V=[F-ah,aq-R],y=[w-F,an-aq],ak=(z+ae+G+ai)>>2,Y=(ao+K+ar+S)>>2,aj=(w+ad+F+ah)>>2,X=(an+J+aq+R)>>2,am,al,aa,Z,U,T,o,n,u,s,I,l,H,k,ag,M,af,L,x,v,ap,t,r;if(ac[0]*(X-ao)-ac[1]*(aj-z)>0&&C[0]*(X-K)-C[1]*(aj-ae)>0&&W[0]*(X-S)-W[1]*(aj-ai)>0&&A[0]*(X-ar)-A[1]*(aj-G)>0){return true;}else{if(ab[0]*(Y-an)-ab[1]*(ak-w)>0&&B[0]*(Y-J)-B[1]*(ak-ad)>0&&V[0]*(Y-R)-V[1]*(ak-ah)>0&&y[0]*(Y-aq)-y[1]*(ak-F)>0){return true;}else{aa=[q,Q,E,au];Z=[p,O,D,at];U=[ac,C,W,A];T=[ab,B,V,y];for(am=0;am<4;am++){o=aa[am];I=o[0];l=o[1];u=U[am];ag=u[0];M=u[1];for(al=0;al<4;al++){n=Z[al];H=n[0];k=n[1];s=T[al];af=s[0];L=s[1];ap=ag*L-M*af;if(ap!==0){x=H-I;v=k-l;t=(x*M-v*ag)/ap;r=(x*L-v*af)/ap;if(0<t&&t<1&&0<r&&r<1){return true;}}}}return false;}}},within:function(k,m){if(this._dirty){this._updateCoordinate();}if(k._dirty){k._updateCoordinate();}if(m==null){m=(this.width+this.height+k.width+k.height)/4;}var l;return(l=this._offsetX-k._offsetX+(this.width-k.width)/2)*l+(l=this._offsetY-k._offsetY+(this.height-k.height)/2)*l<m*m;},scale:function(k,l){this._scaleX*=k;this._scaleY*=(l!=null)?l:k;this._dirty=true;},rotate:function(k){this._rotation+=k;this._dirty=true;},scaleX:{get:function(){return this._scaleX;},set:function(k){this._scaleX=k;this._dirty=true;}},scaleY:{get:function(){return this._scaleY;},set:function(k){this._scaleY=k;this._dirty=true;}},rotation:{get:function(){return this._rotation;},set:function(k){this._rotation=k;this._dirty=true;}},originX:{get:function(){return this._originX;},set:function(k){this._originX=k;this._dirty=true;}},originY:{get:function(){return this._originY;},set:function(k){this._originY=k;this._dirty=true;}},enableCollection:function(){this.addEventListener("addedtoscene",this._addSelfToCollection);this.addEventListener("removedfromscene",this._removeSelfFromCollection);if(this.scene){this._addSelfToCollection();}},disableCollection:function(){this.removeEventListener("addedtoscene",this._addSelfToCollection);this.removeEventListener("removedfromscene",this._removeSelfFromCollection);if(this.scene){this._removeSelfFromCollection();}},_addSelfToCollection:function(){if(this._isContainedInCollection){return;}var k=this.getConstructor();k._collectionTarget.forEach(function(l){l.collection.push(this);},this);this._isContainedInCollection=true;},_removeSelfFromCollection:function(){if(!this._isContainedInCollection){return;}var k=this.getConstructor();k._collectionTarget.forEach(function(m){var l=m.collection.indexOf(this);if(l!==-1){m.collection.splice(l,1);}},this);this._isContainedInCollection=false;},getBoundingRect:function(){var r=this.width||0;var m=this.height||0;var t=this._matrix;var u=t[0]*r,p=t[1]*r,s=t[2]*m,n=t[3]*m,q=t[4],o=t[5];var k=[q,u+q,s+q,u+s+q].sort(function(w,v){return w-v;});var l=[o,p+o,n+o,p+n+o].sort(function(w,v){return w-v;});return{left:k[0],top:l[0],width:k[3]-k[0],height:l[3]-l[0]};},getOrientedBoundingRect:function(){var p=this.width||0;var k=this.height||0;var r=this._matrix;var s=r[0]*p,n=r[1]*p,q=r[2]*k,l=r[3]*k,o=r[4],m=r[5];return{leftTop:[o,m],rightTop:[s+o,n+m],leftBottom:[q+o,l+m],rightBottom:[s+q+o,n+l+m]};},getConstructor:function(){return Object.getPrototypeOf(this).constructor;}});var b=function(m){if(m._collective){return;}var k=g.Class.getInheritanceTree(m);var l=k.indexOf(g.Entity);if(l!==-1){m._collectionTarget=k.splice(0,l+1);}else{m._collectionTarget=[];}m.intersect=d;m.intersectStrict=a;m.collection=[];m._collective=true;};b(g.Entity);g.Entity._inherited=function(k){b(k);};g.Sprite=g.Class.create(g.Entity,{initialize:function(l,k){g.Entity.call(this);this.width=l;this.height=k;this._image=null;this._debugColor="#ff0000";this._frameLeft=0;this._frameTop=0;this._frame=0;this._frameSequence=[];this.addEventListener(g.Event.ENTER_FRAME,this._rotateFrameSequence);},image:{get:function(){return this._image;},set:function(k){if(k===c){throw new Error("Assigned value on Sprite.image is undefined. Please double-check image path, and check if the image you want to use is preload before use.");}if(k===this._image){return;}this._image=k;this._computeFramePosition();}},frame:{get:function(){return this._frame;},set:function(k){if(this._frame===k||(k instanceof Array&&this._deepCompareToPreviousFrame(k))){return;}if(k instanceof Array){this._frameSequence=k.slice();this._originalFrameSequence=k.slice();this._rotateFrameSequence();}else{this._frameSequence=[];this._frame=k;this._computeFramePosition();}}},_deepCompareToPreviousFrame:function(l){if(l===this._originalFrameSequence){return true;}if(l==null||this._originalFrameSequence==null){return false;}if(l.length!==this._originalFrameSequence.length){return false;}for(var k=0;k<l.length;++k){if(l[k]!==this._originalFrameSequence[k]){return false;}}return true;},_computeFramePosition:function(){var k=this._image;var l;if(k!=null){l=k.width/this._width|0;this._frameLeft=(this._frame%l|0)*this._width;this._frameTop=(this._frame/l|0)*this._height%k.height;}},_rotateFrameSequence:function(){if(this._frameSequence.length!==0){var k=this._frameSequence.shift();if(k===null){this._frameSequence=[];this.dispatchEvent(new g.Event(g.Event.ANIMATION_END));}else{this._frame=k;this._computeFramePosition();this._frameSequence.push(k);}}},width:{get:function(){return this._width;},set:function(k){this._width=k;this._computeFramePosition();this._dirty=true;}},height:{get:function(){return this._height;},set:function(k){this._height=k;this._computeFramePosition();this._dirty=true;}},cvsRender:function(u){var l=this._image,s=this._width,o=this._height,m,t,k,q,p,r,n;if(l&&s!==0&&o!==0){m=l.width,t=l.height;if(m<s||t<o){u.fillStyle=g.Surface._getPattern(l);u.fillRect(0,0,s,o);}else{k=l._element;q=this._frameLeft;p=Math.min(this._frameTop,t-o);r=Math.max(0.01,Math.min(m-q,s));n=Math.max(0.01,Math.min(t-p,o));u.drawImage(k,q,p,r,n,0,0,s,o);}}},domRender:(function(){if(g.ENV.VENDOR_PREFIX==="ms"){return function(k){if(this._image){if(this._image._css){this._style["background-image"]=this._image._css;this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px";}else{if(this._image._element){}}}};}else{return function(k){if(this._image){if(this._image._css){this._style["background-image"]=this._image._css;this._style["background-position"]=-this._frameLeft+"px "+-this._frameTop+"px";}else{if(this._image._element){}}}};}}())});g.Label=g.Class.create(g.Entity,{initialize:function(k){g.Entity.call(this);this.text=k||"";this.width=300;this.font="14px serif";this.textAlign="left";this._debugColor="#ff0000";},width:{get:function(){return this._width;},set:function(k){this._width=k;this._dirty=true;this.updateBoundArea();}},text:{get:function(){return this._text;},set:function(o){o=""+o;if(this._text===o){return;}this._text=o;o=o.replace(/<(br|BR) ?\/?>/g,"<br/>");this._splitText=o.split("<br/>");this.updateBoundArea();for(var m=0,k=this._splitText.length;m<k;m++){o=this._splitText[m];var n=this.getMetrics(o);this._splitText[m]={};this._splitText[m].text=o;this._splitText[m].height=n.height;}}},textAlign:{get:function(){return this._style["text-align"];},set:function(k){this._style["text-align"]=k;this.updateBoundArea();}},font:{get:function(){return this._style.font;},set:function(k){this._style.font=k;this.updateBoundArea();}},color:{get:function(){return this._style.color;},set:function(k){this._style.color=k;}},cvsRender:function(A){var w,v=0;var s=this.width;var r,q,B,z,t,n,u,m;var k;if(this._splitText){A.textBaseline="top";A.font=this.font;A.fillStyle=this.color||"#000000";r=A.measureText(" ").width;q=s/r;for(var p=0,o=this._splitText.length;p<o;p++){B=this._splitText[p];z=B.text;t=0;while(z.length>t+q||A.measureText(z.slice(t,t+q)).width>s){n="";u=q;m=0;while(u>0){if(A.measureText(n).width<s){m+=u;n=z.slice(t,t+m);}else{m-=u;n=z.slice(t,t+m);}u=u/2|0;}A.fillText(n,0,v);v+=B.height-1;t+=m;}n=z.slice(t,t+z.length);if(this.textAlign==="right"){w=s-A.measureText(n).width;}else{if(this.textAlign==="center"){w=(s-A.measureText(n).width)/2;}else{w=0;}}A.fillText(n,w,v);v+=B.height-1;}}},domRender:function(k){if(k.innerHTML!==this._text){k.innerHTML=this._text;}},detectRender:function(k){k.fillRect(this._boundOffset,0,this._boundWidth,this._boundHeight);},updateBoundArea:function(){var k=this.getMetrics();this._boundWidth=k.width;this._boundHeight=k.height;if(this.textAlign==="right"){this._boundOffset=this.width-this._boundWidth;}else{if(this.textAlign==="center"){this._boundOffset=(this.width-this._boundWidth)/2;}else{this._boundOffset=0;}}},getMetrics:function(n){var l={};var p,m,k;if(document.body){p=document.createElement("div");for(var o in this._style){if(o!=="width"&&o!=="height"){p.style[o]=this._style[o];}}n=n||this._text;p.innerHTML=n.replace(/ /g,"&nbsp;");p.style.whiteSpace="noWrap";p.style.lineHeight=1;document.body.appendChild(p);l.height=parseInt(getComputedStyle(p).height,10)+1;p.style.position="absolute";l.width=parseInt(getComputedStyle(p).width,10)+1;document.body.removeChild(p);}else{l.width=this.width;l.height=this.height;}return l;}});g.Map=g.Class.create(g.Entity,{initialize:function(o,m){var l=g.Core.instance;g.Entity.call(this);var k=new g.Surface(l.width,l.height);this._surface=k;var n=k._element;n.style.position="absolute";if(g.ENV.RETINA_DISPLAY&&l.scale===2){n.width=l.width*2;n.height=l.height*2;this._style.webkitTransformOrigin="0 0";this._style.webkitTransform="scale(0.5)";}else{n.width=l.width;n.height=l.height;}this._context=n.getContext("2d");this._tileWidth=o||0;this._tileHeight=m||0;this._image=null;this._data=[[[]]];this._dirty=false;this._tight=false;this.touchEnabled=false;this.collisionData=null;this._listeners.render=null;this.addEventListener("render",function(){if(this._dirty||this._previousOffsetX==null){this.redraw(0,0,l.width,l.height);}else{if(this._offsetX!==this._previousOffsetX||this._offsetY!==this._previousOffsetY){if(this._tight){var B=-this._offsetX;var w=-this._offsetY;var D=-this._previousOffsetX;var A=-this._previousOffsetY;var s=B-D+l.width;var q=D-B+l.width;var u=w-A+l.height;var t=A-w+l.height;if(s>this._tileWidth&&q>this._tileWidth&&u>this._tileHeight&&t>this._tileHeight){var z,v,F,E,C,r;if(s<q){z=0;F=D-B;C=s;}else{z=B-D;F=0;C=q;}if(u<t){v=0;E=A-w;r=u;}else{v=w-A;E=0;r=t;}if(l._buffer==null){l._buffer=document.createElement("canvas");l._buffer.width=this._context.canvas.width;l._buffer.height=this._context.canvas.height;}var p=l._buffer.getContext("2d");if(this._doubledImage){p.clearRect(0,0,C*2,r*2);p.drawImage(this._context.canvas,z*2,v*2,C*2,r*2,0,0,C*2,r*2);p=this._context;p.clearRect(F*2,E*2,C*2,r*2);p.drawImage(l._buffer,0,0,C*2,r*2,F*2,E*2,C*2,r*2);}else{p.clearRect(0,0,C,r);p.drawImage(this._context.canvas,z,v,C,r,0,0,C,r);p=this._context;p.clearRect(F,E,C,r);p.drawImage(l._buffer,0,0,C,r,F,E,C,r);}if(F===0){this.redraw(C,0,l.width-C,l.height);}else{this.redraw(0,0,l.width-C,l.height);}if(E===0){this.redraw(0,r,l.width,l.height-r);}else{this.redraw(0,0,l.width,l.height-r);}}else{this.redraw(0,0,l.width,l.height);}}else{this.redraw(0,0,l.width,l.height);}}}this._previousOffsetX=this._offsetX;this._previousOffsetY=this._offsetY;});},loadData:function(p){this._data=Array.prototype.slice.apply(arguments);this._dirty=true;this._tight=false;for(var o=0,m=this._data.length;o<m;o++){var s=0;p=this._data[o];for(var r=0,n=p.length;r<n;r++){for(var k=0,q=p[r].length;k<q;k++){if(p[r][k]>=0){s++;}}}if(s/(p.length*p[0].length)>0.2){this._tight=true;break;}}},checkTile:function(l,q){if(l<0||this.width<=l||q<0||this.height<=q){return false;}var n=this._image.width;var k=this._image.height;var p=this._tileWidth||n;var m=this._tileHeight||k;l=l/p|0;q=q/m|0;var o=this._data[0];return o[q][l];},hitTest:function(t,r){if(t<0||this.width<=t||r<0||this.height<=r){return false;}var k=this._image.width;var u=this._image.height;var s=this._tileWidth||k;var p=this._tileHeight||u;t=t/s|0;r=r/p|0;if(this.collisionData!=null){return this.collisionData[r]&&!!this.collisionData[r][t];}else{for(var o=0,q=this._data.length;o<q;o++){var m=this._data[o];var l;if(m[r]!=null&&(l=m[r][t])!=null&&0<=l&&l<(k/s|0)*(u/p|0)){return true;}}return false;}},image:{get:function(){return this._image;},set:function(m){var l=g.Core.instance;this._image=m;if(g.ENV.RETINA_DISPLAY&&l.scale===2){var n=new g.Surface(m.width*2,m.height*2);var r=this._tileWidth||m.width;var o=this._tileHeight||m.height;var s=m.width/r|0;var k=m.height/o|0;for(var p=0;p<k;p++){for(var q=0;q<s;q++){n.draw(m,q*r,p*o,r,o,q*r*2,p*o*2,r*2,o*2);}}this._doubledImage=n;}this._dirty=true;}},tileWidth:{get:function(){return this._tileWidth;},set:function(k){this._tileWidth=k;this._dirty=true;}},tileHeight:{get:function(){return this._tileHeight;},set:function(k){this._tileHeight=k;this._dirty=true;}},width:{get:function(){return this._tileWidth*this._data[0][0].length;}},height:{get:function(){return this._tileHeight*this._data[0].length;}},redraw:function(v,u,H,E){if(this._image==null){return;}var F,k,t,z,w;if(this._doubledImage){F=this._doubledImage;k=this._tileWidth*2;t=this._tileHeight*2;z=-this._offsetX*2;w=-this._offsetY*2;v*=2;u*=2;H*=2;E*=2;}else{F=this._image;k=this._tileWidth;t=this._tileHeight;z=-this._offsetX;w=-this._offsetY;}var q=F.width/k|0;var p=F.height/t|0;var o=Math.max((v+z)/k|0,0);var C=Math.max((u+w)/t|0,0);var L=Math.ceil((v+z+H)/k);var s=Math.ceil((u+w+E)/t);var I=F._element;var l=this._context;var m=l.canvas;l.clearRect(v,u,H,E);for(var J=0,K=this._data.length;J<K;J++){var N=this._data[J];var B=Math.min(L,N[0].length);var M=Math.min(s,N.length);for(u=C;u<M;u++){for(v=o;v<B;v++){var G=N[u][v];if(0<=G&&G<q*p){var D=(G%q)*k;var A=(G/q|0)*t;l.drawImage(I,D,A,k,t,v*k-z,u*t-w,k,t);}}}}},cvsRender:function(l){var k=g.Core.instance;if(this.width!==0&&this.height!==0){l.save();l.setTransform(1,0,0,1,0,0);var m=this._context.canvas;l.drawImage(m,0,0,k.width,k.height);l.restore();}},domRender:function(k){if(this._image){this._style["background-image"]=this._surface._css;this._style[g.ENV.VENDOR_PREFIX+"Transform"]="matrix(1, 0, 0, 1, 0, 0)";}}});g.Group=g.Class.create(g.Node,{initialize:function(){this.childNodes=[];g.Node.call(this);this._rotation=0;this._scaleX=1;this._scaleY=1;this._originX=null;this._originY=null;this.__dirty=false;[g.Event.ADDED_TO_SCENE,g.Event.REMOVED_FROM_SCENE].forEach(function(k){this.addEventListener(k,function(l){this.childNodes.forEach(function(m){m.scene=this.scene;m.dispatchEvent(l);},this);});},this);},addChild:function(m){if(m.parentNode){m.parentNode.removeChild(m);}this.childNodes.push(m);m.parentNode=this;var k=new g.Event("childadded");k.node=m;k.next=null;this.dispatchEvent(k);m.dispatchEvent(new g.Event("added"));if(this.scene){m.scene=this.scene;var l=new g.Event("addedtoscene");m.dispatchEvent(l);}},insertBefore:function(o,k){if(o.parentNode){o.parentNode.removeChild(o);}var n=this.childNodes.indexOf(k);if(n!==-1){this.childNodes.splice(n,0,o);o.parentNode=this;var l=new g.Event("childadded");l.node=o;l.next=k;this.dispatchEvent(l);o.dispatchEvent(new g.Event("added"));if(this.scene){o.scene=this.scene;var m=new g.Event("addedtoscene");o.dispatchEvent(m);}}else{this.addChild(o);}},removeChild:function(l){var k;if((k=this.childNodes.indexOf(l))!==-1){this.childNodes.splice(k,1);l.parentNode=null;var m=new g.Event("childremoved");m.node=l;this.dispatchEvent(m);l.dispatchEvent(new g.Event("removed"));if(this.scene){l.scene=null;var n=new g.Event("removedfromscene");l.dispatchEvent(n);}}},firstChild:{get:function(){return this.childNodes[0];}},lastChild:{get:function(){return this.childNodes[this.childNodes.length-1];}},rotation:{get:function(){return this._rotation;},set:function(k){this._rotation=k;this._dirty=true;}},scaleX:{get:function(){return this._scaleX;},set:function(k){this._scaleX=k;this._dirty=true;}},scaleY:{get:function(){return this._scaleY;},set:function(k){this._scaleY=k;this._dirty=true;}},originX:{get:function(){return this._originX;},set:function(k){this._originX=k;this._dirty=true;}},originY:{get:function(){return this._originY;},set:function(k){this._originY=k;this._dirty=true;}},_dirty:{get:function(){return this.__dirty;},set:function(n){n=!!n;this.__dirty=n;if(n){for(var m=0,k=this.childNodes.length;m<k;m++){this.childNodes[m]._dirty=true;}}}}});g.Matrix=g.Class.create({initialize:function(){this.reset();},reset:function(){this.stack=[];this.stack.push([1,0,0,1,0,0]);},makeTransformMatrix:function(t,o){var p=t._x;var n=t._y;var s=t.width||0;var r=t.height||0;var u=t._rotation||0;var C=(typeof t._scaleX==="number")?t._scaleX:1;var A=(typeof t._scaleY==="number")?t._scaleY:1;var m=u*Math.PI/180;var l=Math.cos(m);var k=Math.sin(m);var q=(typeof t._originX==="number")?t._originX:s/2;var v=(typeof t._originY==="number")?t._originY:r/2;var E=C*l;var D=C*k;var B=A*k;var z=A*l;o[0]=E;o[1]=D;o[2]=-B;o[3]=z;o[4]=(-E*q+B*v+p+q);o[5]=(-D*q-z*v+n+v);},multiply:function(y,w,u){var x=y[0],r=y[2],m=y[4],v=y[1],q=y[3],k=y[5];var n=w[0],t=w[2],p=w[4],l=w[1],s=w[3],o=w[5];u[0]=x*n+r*l;u[1]=v*n+q*l;u[2]=x*t+r*s;u[3]=v*t+q*s;u[4]=x*p+r*o+m;u[5]=v*p+q*o+k;},multiplyVec:function(u,m,t){var s=m[0],r=m[1];var o=u[0],l=u[2],q=u[4],n=u[1],k=u[3],p=u[5];t[0]=o*s+l*r+q;t[1]=n*s+k*r+p;}});g.Matrix.instance=new g.Matrix();g.DetectColorManager=g.Class.create({initialize:function(o,k){this.reference=[];this.colorResolution=o||16;this.max=k||1;this.capacity=Math.pow(this.colorResolution,3);for(var n=1,m=this.capacity;n<m;n++){this.reference[n]=null;}},attachDetectColor:function(l){var k=this.reference.indexOf(null);if(k===-1){k=1;}this.reference[k]=l;return this._getColor(k);},detachDetectColor:function(l){var k=this.reference.indexOf(l);if(k!==-1){this.reference[k]=null;}},_getColor:function(m){var l=this.colorResolution;var k=l/this.max;return[parseInt((m/l/l)%l,10)/k,parseInt((m/l)%l,10)/k,parseInt(m%l,10)/k,1];},_decodeDetectColor:function(k){var l=this.colorResolution;return ~~(k[0]*l*l*l/256)+~~(k[1]*l*l/256)+~~(k[2]*l/256);},getSpriteByColor:function(k){return this.reference[this._decodeDetectColor(k)];}});g.DomManager=g.Class.create({initialize:function(m,n){var k=g.Core.instance;this.layer=null;this.targetNode=m;if(typeof n==="string"){this.element=document.createElement(n);}else{if(n instanceof HTMLElement){this.element=n;}}this.style=this.element.style;this.style.position="absolute";this.style[g.ENV.VENDOR_PREFIX+"TransformOrigin"]="0px 0px";if(k._debug){this.style.border="1px solid blue";this.style.margin="-1px";}var l=this;this._setDomTarget=function(){l.layer._touchEventTarget=l.targetNode;};this._attachEvent();},getDomElement:function(){return this.element;},getDomElementAsNext:function(){return this.element;},getNextManager:function(l){var k=this.targetNode.parentNode.childNodes.indexOf(l.targetNode);if(k!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[k+1]._domManager;}else{return null;}},addManager:function(k,n){var m;if(n){m=n.getDomElementAsNext();}var l=k.getDomElement();if(l instanceof Array){l.forEach(function(o){if(m){this.element.insertBefore(o,m);}else{this.element.appendChild(o);}},this);}else{if(m){this.element.insertBefore(l,m);}else{this.element.appendChild(l);}}this.setLayer(this.layer);},removeManager:function(k){if(k instanceof g.DomlessManager){k._domRef.forEach(function(l){this.element.removeChild(l);},this);}else{this.element.removeChild(k.element);}this.setLayer(this.layer);},setLayer:function(o){this.layer=o;var p=this.targetNode;var n;if(p.childNodes){for(var m=0,k=p.childNodes.length;m<k;m++){n=p.childNodes[m]._domManager;if(n){n.setLayer(o);}}}},render:function(r){var q=this.targetNode;var n=g.Matrix.instance;var k=n.stack;var o=[];n.makeTransformMatrix(q,o);n.multiply(k[k.length-1],o,o);n.multiply(r,o,r);q._matrix=r;var m=(typeof q._originX==="number")?q._originX:q.width/2||0;var l=(typeof q._originY==="number")?q._originY:q.height/2||0;var p=[m,l];n.multiplyVec(o,p,p);q._offsetX=p[0]-m;q._offsetY=p[1]-l;if(q.parentNode&&!(q.parentNode instanceof g.Group)){q._offsetX+=q.parentNode._offsetX;q._offsetY+=q.parentNode._offsetY;}if(q._dirty){this.style[g.ENV.VENDOR_PREFIX+"Transform"]="matrix("+o[0].toFixed(10)+","+o[1].toFixed(10)+","+o[2].toFixed(10)+","+o[3].toFixed(10)+","+o[4].toFixed(10)+","+o[5].toFixed(10)+")";}this.domRender();},domRender:function(){var k=this.targetNode;if(!k._style){k._style={};}if(!k.__styleStatus){k.__styleStatus={};}if(k.width!==null){k._style.width=k.width+"px";}if(k.height!==null){k._style.height=k.height+"px";}k._style.opacity=k._opacity;k._style["background-color"]=k._backgroundColor;if(typeof k._visible!=="undefined"){k._style.display=k._visible?"block":"none";}if(typeof k.domRender==="function"){k.domRender(this.element);}var l;for(var m in k._style){l=k._style[m];if(k.__styleStatus[m]!==l&&l!=null){this.style.setProperty(m,""+l);k.__styleStatus[m]=l;}}},_attachEvent:function(){if(g.ENV.TOUCH_ENABLED){this.element.addEventListener("touchstart",this._setDomTarget,true);}this.element.addEventListener("mousedown",this._setDomTarget,true);},_detachEvent:function(){if(g.ENV.TOUCH_ENABLED){this.element.removeEventListener("touchstart",this._setDomTarget,true);}this.element.removeEventListener("mousedown",this._setDomTarget,true);},remove:function(){this._detachEvent();this.element=this.style=this.targetNode=null;}});g.DomlessManager=g.Class.create({initialize:function(k){this._domRef=[];this.targetNode=k;},_register:function(m,l){var k=this._domRef.indexOf(l);var n;if(m instanceof Array){if(k===-1){Array.prototype.push.apply(this._domRef,m);}else{Array.prototype.splice.apply(this._domRef,[k,0].concat(m));}}else{if(k===-1){this._domRef.push(m);}else{this._domRef.splice(k,0,m);}}},getNextManager:function(l){var k=this.targetNode.parentNode.childNodes.indexOf(l.targetNode);if(k!==this.targetNode.parentNode.childNodes.length-1){return this.targetNode.parentNode.childNodes[k+1]._domManager;}else{return null;}},getDomElement:function(){var k=[];this.targetNode.childNodes.forEach(function(l){k=k.concat(l._domManager.getDomElement());});return k;},getDomElementAsNext:function(){if(this._domRef.length){return this._domRef[0];}else{var k=this.getNextManager(this);if(k){return k.element;}else{return null;}}},addManager:function(l,n){var k=this.targetNode.parentNode;if(k){if(n===null){n=this.getNextManager(this);}if(k instanceof g.Scene){k._layers.Dom._domManager.addManager(l,n);}else{k._domManager.addManager(l,n);}}var m=n?n.getDomElementAsNext():null;this._register(l.getDomElement(),m);this.setLayer(this.layer);},removeManager:function(k){var m;var l=this._domRef.indexOf(k.element);if(l!==-1){m=this._domRef[l];m.parentNode.removeChild(m);this._domRef.splice(l,1);}this.setLayer(this.layer);},setLayer:function(o){this.layer=o;var p=this.targetNode;var n;if(p.childNodes){for(var m=0,k=p.childNodes.length;m<k;m++){n=p.childNodes[m]._domManager;if(n){n.setLayer(o);}}}},render:function(r){var n=g.Matrix.instance;var k=n.stack;var q=this.targetNode;var o=[];n.makeTransformMatrix(q,o);n.multiply(k[k.length-1],o,o);n.multiply(r,o,r);q._matrix=r;var m=(typeof q._originX==="number")?q._originX:q.width/2||0;var l=(typeof q._originY==="number")?q._originY:q.height/2||0;var p=[m,l];n.multiplyVec(o,p,p);q._offsetX=p[0]-m;q._offsetY=p[1]-l;k.push(o);},remove:function(){this._domRef=[];this.targetNode=null;}});g.DomLayer=g.Class.create(g.Group,{initialize:function(){var k=g.Core.instance;g.Group.call(this);this._touchEventTarget=null;this._element=document.createElement("div");this._element.style.position="absolute";this._domManager=new g.DomManager(this,this._element);this._domManager.layer=this;this.width=k.width;this.height=k.height;var n=[g.Event.TOUCH_START,g.Event.TOUCH_MOVE,g.Event.TOUCH_END];n.forEach(function(o){this.addEventListener(o,function(p){if(this._scene){this._scene.dispatchEvent(p);}});},this);var l=function(s){var t=s.node;var q=s.next;var o=s.target;var r=q?q._domManager:null;g.DomLayer._attachDomManager(t,l,m);o._domManager.addManager(t._domManager,r);var p=new g.Event(g.Event.RENDER);t._dirty=true;o._domManager.layer._rendering(t,p);};var m=function(p){var q=p.node;var o=p.target;o._domManager.removeManager(q._domManager);g.DomLayer._detachDomManager(q,l,m);};this.addEventListener("childremoved",m);this.addEventListener("childadded",l);},width:{get:function(){return this._width;},set:function(k){this._width=k;this._element.style.width=k+"px";}},height:{get:function(){return this._height;},set:function(k){this._height=k;this._element.style.height=k+"px";}},addChild:function(m){this.childNodes.push(m);m.parentNode=this;var k=new g.Event("childadded");k.node=m;k.next=null;this.dispatchEvent(k);m.dispatchEvent(new g.Event("added"));if(this.scene){m.scene=this.scene;var l=new g.Event("addedtoscene");m.dispatchEvent(l);}},insertBefore:function(o,k){var n=this.childNodes.indexOf(k);if(n!==-1){this.childNodes.splice(n,0,o);o.parentNode=this;var l=new g.Event("childadded");l.node=o;l.next=k;this.dispatchEvent(l);o.dispatchEvent(new g.Event("added"));if(this.scene){o.scene=this.scene;var m=new g.Event("addedtoscene");o.dispatchEvent(m);}}else{this.addChild(o);}},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe();},_stopRendering:function(){this.removeEventListener("exitframe",this._onexitframe);this._onexitframe();},_onexitframe:function(){this._rendering(this,new g.Event(g.Event.RENDER));},_rendering:function(n,o,p){var q;if(!p){p=[1,0,0,1,0,0];}n.dispatchEvent(o);n._domManager.render(p);if(n.childNodes){for(var m=0,k=n.childNodes.length;m<k;m++){q=n.childNodes[m];this._rendering(q,o,p.slice());}}if(n._domManager instanceof g.DomlessManager){g.Matrix.instance.stack.pop();}n._dirty=false;},_determineEventTarget:function(){var k=this._touchEventTarget;this._touchEventTarget=null;return(k===this)?null:k;}});g.DomLayer._attachDomManager=function(p,o,n){var q;if(!p._domManager){p.addEventListener("childadded",o);p.addEventListener("childremoved",n);if(p instanceof g.Group){p._domManager=new g.DomlessManager(p);}else{if(p._element){p._domManager=new g.DomManager(p,p._element);}else{p._domManager=new g.DomManager(p,"div");}}}if(p.childNodes){for(var m=0,k=p.childNodes.length;m<k;m++){q=p.childNodes[m];g.DomLayer._attachDomManager(q,o,n);p._domManager.addManager(q._domManager,null);}}};g.DomLayer._detachDomManager=function(p,o,n){var q;p.removeEventListener("childadded",o);p.removeEventListener("childremoved",n);if(p.childNodes){for(var m=0,k=p.childNodes.length;m<k;m++){q=p.childNodes[m];p._domManager.removeManager(q._domManager,null);g.DomLayer._detachDomManager(q,o,n);}}p._domManager.remove();delete p._domManager;};g.CanvasLayer=g.Class.create(g.Group,{initialize:function(){var k=g.Core.instance;g.Group.call(this);this._cvsCache={matrix:[1,0,0,1,0,0],detectColor:"#000000"};this._cvsCache.layer=this;this._element=document.createElement("canvas");this._element.style.position="absolute";this._element.style.left=this._element.style.top="0px";this._detect=document.createElement("canvas");this._detect.style.position="absolute";this._lastDetected=0;this.context=this._element.getContext("2d");this._dctx=this._detect.getContext("2d");this._colorManager=new g.DetectColorManager(16,256);this.width=k.width;this.height=k.height;var n=[g.Event.TOUCH_START,g.Event.TOUCH_MOVE,g.Event.TOUCH_END];n.forEach(function(o){this.addEventListener(o,function(p){if(this._scene){this._scene.dispatchEvent(p);}});},this);var l=function(r){var s=r.node;var o=r.target;var p;if(o instanceof g.CanvasLayer){p=o._scene._layers.Canvas;}else{p=o.scene._layers.Canvas;}g.CanvasLayer._attachCache(s,p,l,m);var q=new g.Event(g.Event.RENDER);if(o._dirty){o._updateCoordinate();}s._dirty=true;g.Matrix.instance.stack.push(o._matrix);g.CanvasRenderer.instance.render(p.context,s,q);g.Matrix.instance.stack.pop(o._matrix);};var m=function(q){var r=q.node;var o=q.target;var p;if(o instanceof g.CanvasLayer){p=o._scene._layers.Canvas;}else{p=o.scene._layers.Canvas;}g.CanvasLayer._detachCache(r,p,l,m);};this.addEventListener("childremoved",m);this.addEventListener("childadded",l);},width:{get:function(){return this._width;},set:function(k){this._width=k;this._element.width=this._detect.width=k;}},height:{get:function(){return this._height;},set:function(k){this._height=k;this._element.height=this._detect.height=k;}},addChild:function(m){this.childNodes.push(m);m.parentNode=this;var k=new g.Event("childadded");k.node=m;k.next=null;this.dispatchEvent(k);m.dispatchEvent(new g.Event("added"));if(this.scene){m.scene=this.scene;var l=new g.Event("addedtoscene");m.dispatchEvent(l);}},insertBefore:function(o,k){var n=this.childNodes.indexOf(k);if(n!==-1){this.childNodes.splice(n,0,o);o.parentNode=this;var l=new g.Event("childadded");l.node=o;l.next=k;this.dispatchEvent(l);o.dispatchEvent(new g.Event("added"));if(this.scene){o.scene=this.scene;var m=new g.Event("addedtoscene");o.dispatchEvent(m);}}else{this.addChild(o);}},_startRendering:function(){this.addEventListener("exitframe",this._onexitframe);this._onexitframe(new g.Event(g.Event.RENDER));},_stopRendering:function(){this.removeEventListener("render",this._onexitframe);this._onexitframe(new g.Event(g.Event.RENDER));},_onexitframe:function(){var l=g.Core.instance;var k=this.context;k.clearRect(0,0,l.width,l.height);var m=new g.Event(g.Event.RENDER);g.CanvasRenderer.instance.render(k,this,m);},_determineEventTarget:function(k){return this._getEntityByPosition(k.x,k.y);},_getEntityByPosition:function(k,o){var m=g.Core.instance;var l=this._dctx;if(this._lastDetected<m.frame){l.clearRect(0,0,this.width,this.height);g.CanvasRenderer.instance.detectRender(l,this);this._lastDetected=m.frame;}var n=l.getImageData(k,o,1,1).data;return this._colorManager.getSpriteByColor(n);}});g.CanvasLayer._attachCache=function(q,o,p,n){var r;if(!q._cvsCache){q._cvsCache={};q._cvsCache.matrix=[1,0,0,1,0,0];q._cvsCache.detectColor="rgba("+o._colorManager.attachDetectColor(q)+")";q.addEventListener("childadded",p);q.addEventListener("childremoved",n);}if(q.childNodes){for(var m=0,k=q.childNodes.length;m<k;m++){r=q.childNodes[m];g.CanvasLayer._attachCache(r,o,p,n);}}};g.CanvasLayer._detachCache=function(q,o,p,n){var r;if(q._cvsCache){o._colorManager.detachDetectColor(q);q.removeEventListener("childadded",p);q.removeEventListener("childremoved",n);delete q._cvsCache;}if(q.childNodes){for(var m=0,k=q.childNodes.length;m<k;m++){r=q.childNodes[m];g.CanvasLayer._detachCache(r,o,p,n);}}};g.CanvasRenderer=g.Class.create({render:function(n,q,r){var p,k,s;n.save();q.dispatchEvent(r);this.transform(n,q);if(typeof q._visible==="undefined"||q._visible){p=q.width;k=q.height;if(q.compositeOperation){n.globalCompositeOperation=q.compositeOperation;}n.globalAlpha=(typeof q._opacity==="number")?q._opacity:1;if(q._backgroundColor){n.fillStyle=q._backgroundColor;n.fillRect(0,0,p,k);}if(q.cvsRender){q.cvsRender(n);}if(g.Core.instance._debug&&q._debugColor){n.strokeStyle=q._debugColor;n.strokeRect(0,0,p,k);}if(q._clipping){n.beginPath();n.rect(0,0,p,k);n.clip();}if(q.childNodes){for(var o=0,m=q.childNodes.length;o<m;o++){s=q.childNodes[o];this.render(n,s,r);}}}n.restore();g.Matrix.instance.stack.pop();},detectRender:function(n,q){var p,k,r;if(typeof q._visible==="undefined"||q._visible){p=q.width;k=q.height;n.save();this.transform(n,q);n.fillStyle=q._cvsCache.detectColor;if(q._touchEnabled){if(q.detectRender){q.detectRender(n);}else{n.fillRect(0,0,p,k);}}if(q._clipping){n.beginPath();n.rect(0,0,p,k);n.clip();}if(q.childNodes){for(var o=0,m=q.childNodes.length;o<m;o++){r=q.childNodes[o];this.detectRender(n,r);}}n.restore();g.Matrix.instance.stack.pop();}},transform:function(m,r){var p=g.Matrix.instance;var k=p.stack;var o,n,l,q;if(r._dirty){p.makeTransformMatrix(r,r._cvsCache.matrix);o=[];p.multiply(k[k.length-1],r._cvsCache.matrix,o);r._matrix=o;n=(typeof r._originX==="number")?r._originX:r._width/2||0;l=(typeof r._originY==="number")?r._originY:r._height/2||0;q=[n,l];p.multiplyVec(o,q,q);r._offsetX=q[0]-n;r._offsetY=q[1]-l;r._dirty=false;}else{o=r._matrix;}k.push(o);m.setTransform.apply(m,o);}});g.CanvasRenderer.instance=new g.CanvasRenderer();g.Scene=g.Class.create(g.Group,{initialize:function(){var k=g.Core.instance;g.Group.call(this);this.scene=this;this._backgroundColor=null;this._element=document.createElement("div");this._element.style.position="absolute";this._element.style.overflow="hidden";this._element.style[g.ENV.VENDOR_PREFIX+"TransformOrigin"]="0 0";this._layers={};this._layerPriority=[];this.addEventListener(g.Event.CHILD_ADDED,this._onchildadded);this.addEventListener(g.Event.CHILD_REMOVED,this._onchildremoved);this.addEventListener(g.Event.ENTER,this._onenter);this.addEventListener(g.Event.EXIT,this._onexit);var l=this;this._dispatchExitframe=function(){var m;for(var n in l._layers){m=l._layers[n];m.dispatchEvent(new g.Event(g.Event.EXIT_FRAME));}};this.addEventListener(g.Event.CORE_RESIZE,this._oncoreresize);this._oncoreresize(k);},x:{get:function(){return this._x;},set:function(k){this._x=k;for(var l in this._layers){this._layers[l].x=k;}}},y:{get:function(){return this._y;},set:function(l){this._y=l;for(var k in this._layers){this._layers[k].y=l;}}},width:{get:function(){return this._width;},set:function(l){this._width=l;for(var k in this._layers){this._layers[k].width=l;}}},height:{get:function(){return this._height;},set:function(k){this._height=k;for(var l in this._layers){this._layers[l].height=k;}}},rotation:{get:function(){return this._rotation;},set:function(k){this._rotation=k;for(var l in this._layers){this._layers[l].rotation=k;}}},scaleX:{get:function(){return this._scaleX;},set:function(k){this._scaleX=k;for(var l in this._layers){this._layers[l].scaleX=k;}}},scaleY:{get:function(){return this._scaleY;},set:function(k){this._scaleY=k;for(var l in this._layers){this._layers[l].scaleY=k;}}},backgroundColor:{get:function(){return this._backgroundColor;},set:function(k){this._backgroundColor=this._element.style.backgroundColor=k;}},_oncoreresize:function(l){this._element.style.width=l.width+"px";this.width=l.width;this._element.style.height=l.height+"px";this.height=l.height;this._element.style[g.ENV.VENDOR_PREFIX+"Transform"]="scale("+l.scale+")";for(var k in this._layers){this._layers[k].dispatchEvent(l);}},addLayer:function(o,n){var k=g.Core.instance;if(this._layers[o]){return;}var m=new g[o+"Layer"]();if(k.currentScene===this){m._startRendering();}this._layers[o]=m;var l=m._element;if(typeof n==="number"){var p=this._element.childNodes[n];if(p){this._element.insertBefore(l,p);}else{this._element.appendChild(l);}this._layerPriority.splice(n,0,o);}else{this._element.appendChild(l);this._layerPriority.push(o);}m._scene=this;},_determineEventTarget:function(n){var l,m;for(var k=this._layerPriority.length-1;k>=0;k--){l=this._layers[this._layerPriority[k]];m=l._determineEventTarget(n);if(m){break;}}if(!m){m=this;}return m;},_onchildadded:function(n){var o=n.node;var l=n.next;var m,k;if(o._element){m="Dom";k=1;}else{m="Canvas";k=0;}if(!this._layers[m]){this.addLayer(m,k);}o._layer=this._layers[m];this._layers[m].insertBefore(o,l);o.parentNode=this;},_onchildremoved:function(k){var l=k.node;l._layer.removeChild(l);l._layer=null;},_onenter:function(){for(var k in this._layers){this._layers[k]._startRendering();}g.Core.instance.addEventListener("exitframe",this._dispatchExitframe);},_onexit:function(){for(var k in this._layers){this._layers[k]._stopRendering();}g.Core.instance.removeEventListener("exitframe",this._dispatchExitframe);}});g.LoadingScene=g.Class.create(g.Scene,{initialize:function(){g.Scene.call(this);this.backgroundColor="#000";var n=this.width*0.4|0;var q=this.width*0.05|0;var l=n*0.03|0;var o=new g.Sprite(n,q);o.disableCollection();o.x=(this.width-n)/2;o.y=(this.height-q)/2;var p=new g.Surface(n,q);p.context.fillStyle="#fff";p.context.fillRect(0,0,n,q);p.context.fillStyle="#000";p.context.fillRect(l,l,n-l*2,q-l*2);o.image=p;var k=0,m=0;this.addEventListener("progress",function(r){k=r.loaded/r.total*1;});o.addEventListener("enterframe",function(){m*=0.9;m+=k*0.1;p.context.fillStyle="#fff";p.context.fillRect(l,0,(n-l*2)*m,q);});this.addChild(o);this.addEventListener("load",function(s){var r=g.Core.instance;r.removeScene(r.loadingScene);r.dispatchEvent(s);});}});g.CanvasScene=g.Class.create(g.Scene,{initialize:function(){g.Scene.call(this);this.addLayer("Canvas");},_determineEventTarget:function(l){var k=this._layers.Canvas._determineEventTarget(l);if(!k){k=this;}return k;},_onchildadded:function(l){var m=l.node;var k=l.next;m._layer=this._layers.Canvas;this._layers.Canvas.insertBefore(m,k);},_onenter:function(){this._layers.Canvas._startRendering();g.Core.instance.addEventListener("exitframe",this._dispatchExitframe);},_onexit:function(){this._layers.Canvas._stopRendering();g.Core.instance.removeEventListener("exitframe",this._dispatchExitframe);}});g.DOMScene=g.Class.create(g.Scene,{initialize:function(){g.Scene.call(this);this.addLayer("Dom");},_determineEventTarget:function(l){var k=this._layers.Dom._determineEventTarget(l);if(!k){k=this;}return k;},_onchildadded:function(l){var m=l.node;var k=l.next;m._layer=this._layers.Dom;this._layers.Dom.insertBefore(m,k);},_onenter:function(){this._layers.Dom._startRendering();g.Core.instance.addEventListener("exitframe",this._dispatchExitframe);},_onexit:function(){this._layers.Dom._stopRendering();g.Core.instance.removeEventListener("exitframe",this._dispatchExitframe);}});g.Surface=g.Class.create(g.EventTarget,{initialize:function(n,k){g.EventTarget.call(this);var l=g.Core.instance;this.width=n;this.height=k;this.context=null;var o="enchant-surface"+l._surfaceID++;if(document.getCSSCanvasContext){this.context=document.getCSSCanvasContext("2d",o,n,k);this._element=this.context.canvas;this._css="-webkit-canvas("+o+")";var m=this.context;}else{if(document.mozSetImageElement){this._element=document.createElement("canvas");this._element.width=n;this._element.height=k;this._css="-moz-element(#"+o+")";this.context=this._element.getContext("2d");document.mozSetImageElement(o,this._element);}else{this._element=document.createElement("canvas");this._element.width=n;this._element.height=k;this._element.style.position="absolute";this.context=this._element.getContext("2d");g.ENV.CANVAS_DRAWING_METHODS.forEach(function(p){var q=this.context[p];this.context[p]=function(){q.apply(this,arguments);this._dirty=true;};},this);}}},getPixel:function(k,l){return this.context.getImageData(k,l,1,1).data;},setPixel:function(l,q,p,o,k,m){var n=this.context.createImageData(1,1);n.data[0]=p;n.data[1]=o;n.data[2]=k;n.data[3]=m;this.context.putImageData(n,l,q);},clear:function(){this.context.clearRect(0,0,this.width,this.height);},draw:function(l){l=l._element;if(arguments.length===1){this.context.drawImage(l,0,0);}else{var k=arguments;k[0]=l;this.context.drawImage.apply(this.context,k);}},clone:function(){var k=new g.Surface(this.width,this.height);k.draw(this);return k;},toDataURL:function(){var k=this._element.src;if(k){if(k.slice(0,5)==="data:"){return k;}else{return this.clone().toDataURL();}}else{return this._element.toDataURL();}}});g.Surface.load=function(n,o,l){var m=new Image();var k=Object.create(g.Surface.prototype,{context:{value:null},_css:{value:"url("+n+")"},_element:{value:m}});g.EventTarget.call(k);l=l||function(){};k.addEventListener("load",o);k.addEventListener("error",l);m.onerror=function(){var p=new g.Event(g.Event.ERROR);p.message="Cannot load an asset: "+m.src;g.Core.instance.dispatchEvent(p);k.dispatchEvent(p);};m.onload=function(){k.width=m.width;k.height=m.height;k.dispatchEvent(new g.Event("load"));};m.src=n;return k;};g.Surface._staticCanvas2DContext=document.createElement("canvas").getContext("2d");g.Surface._getPattern=function(k,l){if(!k._pattern||l){k._pattern=this._staticCanvas2DContext.createPattern(k._element,"repeat");}return k._pattern;};if(f.Deferred){g.Deferred=f.Deferred;}else{g.Deferred=g.Class.create({initialize:function(){this._succ=this._fail=this._next=this._id=null;this._tail=this;},next:function(k){var l=new g.Deferred();l._succ=k;return this._add(l);},error:function(k){var l=new g.Deferred();l._fail=k;return this._add(l);},_add:function(k){this._tail._next=k;this._tail=k;return this;},call:function(l){var n;var k=this;while(k&&!k._succ){k=k._next;}if(!(k instanceof g.Deferred)){return;}try{n=k._succ(l);}catch(m){return k.fail(m);}if(n instanceof g.Deferred){g.Deferred._insert(k,n);}else{if(k._next instanceof g.Deferred){k._next.call(n);}}},fail:function(m){var l,n,k=this;while(k&&!k._fail){k=k._next;}if(k instanceof g.Deferred){l=k._fail(m);k.call(l);}else{if(m instanceof Error){throw m;}else{n=new Error("failed in Deferred");n.arg=m;throw n;}}}});g.Deferred._insert=function(k,l){if(k._next instanceof g.Deferred){l._tail._next=k._next;}k._next=l;};g.Deferred.next=function(k){var l=new g.Deferred().next(k);l._id=setTimeout(function(){l.call();},0);return l;};g.Deferred.parallel=function(k){var n=new g.Deferred();n._id=setTimeout(function(){n.call();},0);var m=0;var l=(k instanceof Array)?[]:{};var o=new g.Deferred();for(var r in k){if(k.hasOwnProperty(r)){m++;(function(p,q){p.next(function(s){m--;l[q]=s;if(m<=0){o.call(l);}}).error(function(s){o.fail(s);});if(typeof p._id==="number"){clearTimeout(p._id);}p._id=setTimeout(function(){p.call();},0);}(k[r],r));}}if(!m){o._id=setTimeout(function(){o.call(l);},0);}return n.next(function(){return o;});};}g.DOMSound=g.Class.create(g.EventTarget,{initialize:function(){g.EventTarget.call(this);this.duration=0;throw new Error("Illegal Constructor");},play:function(){if(this._element){this._element.play();}},pause:function(){if(this._element){this._element.pause();}},stop:function(){this.pause();this.currentTime=0;},clone:function(){var k;if(this._element instanceof Audio){k=Object.create(g.DOMSound.prototype,{_element:{value:this._element.cloneNode(false)},duration:{value:this.duration}});}else{if(g.ENV.USE_FLASH_SOUND){return this;}else{k=Object.create(g.DOMSound.prototype);}}g.EventTarget.call(k);return k;},currentTime:{get:function(){return this._element?this._element.currentTime:0;},set:function(k){if(this._element){this._element.currentTime=k;}}},volume:{get:function(){return this._element?this._element.volume:1;},set:function(k){if(this._element){this._element.volume=k;}}}});g.DOMSound.load=function(k,q,t,r){if(q==null){var m=g.Core.findExt(k);if(m){q="audio/"+m;}else{q="";}}q=q.replace("mp3","mpeg").replace("m4a","mp4");t=t||function(){};r=r||function(){};var s=Object.create(g.DOMSound.prototype);g.EventTarget.call(s);s.addEventListener("load",t);s.addEventListener("error",r);var o=new Audio();if(!g.ENV.SOUND_ENABLED_ON_MOBILE_SAFARI&&g.ENV.VENDOR_PREFIX==="webkit"&&g.ENV.TOUCH_ENABLED){f.setTimeout(function(){s.dispatchEvent(new g.Event("load"));},0);}else{if(!g.ENV.USE_FLASH_SOUND&&o.canPlayType(q)){o.addEventListener("canplaythrough",function n(){s.duration=o.duration;s.dispatchEvent(new g.Event("load"));o.removeEventListener("canplaythrough",n);},false);o.src=k;o.load();o.autoplay=false;o.onerror=function(){var u=new g.Event(g.Event.ERROR);u.message="Cannot load an asset: "+o.src;g.Core.instance.dispatchEvent(u);s.dispatchEvent(u);};s._element=o;}else{if(q==="audio/mpeg"){var p=document.createElement("embed");var l="enchant-audio"+g.Core.instance._soundID++;p.width=p.height=1;p.name=l;p.src="sound.swf?id="+l+"&src="+k;p.allowscriptaccess="always";p.style.position="absolute";p.style.left="-1px";s.addEventListener("load",function(){Object.defineProperties(p,{currentTime:{get:function(){return p.getCurrentTime();},set:function(u){p.setCurrentTime(u);}},volume:{get:function(){return p.getVolume();},set:function(u){p.setVolume(u);}}});s._element=p;s.duration=p.getDuration();});g.Core.instance._element.appendChild(p);g.DOMSound[l]=s;}else{f.setTimeout(function(){s.dispatchEvent(new g.Event("load"));},0);}}}return s;};f.AudioContext=f.AudioContext||f.webkitAudioContext||f.mozAudioContext||f.msAudioContext||f.oAudioContext;g.WebAudioSound=g.Class.create(g.EventTarget,{initialize:function(){if(!f.AudioContext){throw new Error("This browser does not support WebAudio API.");}g.EventTarget.call(this);this.context=g.WebAudioSound.audioContext;this.src=this.context.createBufferSource();this.buffer=null;this._volume=1;this._currentTime=0;this._state=0;this.connectTarget=g.WebAudioSound.destination;},play:function(l){if(this._state===1&&!l){this.src.disconnect(this.connectTarget);}if(this._state!==2){this._currentTime=0;}var m=this._currentTime;var k=this.context;this.src=k.createBufferSource();if(k.createGain!=null){this._gain=k.createGain();}else{this._gain=k.createGainNode();}this.src.buffer=this.buffer;this._gain.gain.value=this._volume;this.src.connect(this._gain);this._gain.connect(this.connectTarget);if(this.src.start!=null){this.src.start(0,m,this.buffer.duration-m-1.192e-7);}else{this.src.noteGrainOn(0,m,this.buffer.duration-m-1.192e-7);}this._startTime=k.currentTime-this._currentTime;this._state=1;},pause:function(){var k=this.currentTime;if(k===this.duration){return;}if(this.src.stop!=null){this.src.stop(0);}else{this.src.noteOff(0);}this._currentTime=k;this._state=2;},stop:function(){if(this.src.stop!=null){this.src.stop(0);}else{this.src.noteOff(0);}this._state=0;},clone:function(){var k=new g.WebAudioSound();k.buffer=this.buffer;return k;},duration:{get:function(){if(this.buffer){return this.buffer.duration;}else{return 0;}}},volume:{get:function(){return this._volume;},set:function(k){k=Math.max(0,Math.min(1,k));this._volume=k;if(this.src){this._gain.gain.value=k;}}},currentTime:{get:function(){return Math.max(0,Math.min(this.duration,this.src.context.currentTime-this._startTime));},set:function(k){this._currentTime=k;if(this._state!==2){this.play(false);}}}});g.WebAudioSound.load=function(k,o,r,p){var m=(new Audio()).canPlayType(o);var q=new g.WebAudioSound();r=r||function(){};p=p||function(){};q.addEventListener(g.Event.LOAD,r);q.addEventListener(g.Event.ERROR,p);function l(){var t=new g.Event(g.Event.ERROR);t.message="Cannot load an asset: "+k;g.Core.instance.dispatchEvent(t);q.dispatchEvent(t);}var n,s;if(m==="maybe"||m==="probably"){n=g.WebAudioSound.audioContext;s=new XMLHttpRequest();s.open("GET",k,true);s.responseType="arraybuffer";s.onload=function(){n.decodeAudioData(s.response,function(t){q.buffer=t;q.dispatchEvent(new g.Event(g.Event.LOAD));},l);};s.onerror=l;s.send(null);}else{setTimeout(l,50);}return q;};if(f.AudioContext){g.WebAudioSound.audioContext=new f.AudioContext();g.WebAudioSound.destination=g.WebAudioSound.audioContext.destination;}g.Sound=f.AudioContext&&g.ENV.USE_WEBAUDIO?g.WebAudioSound:g.DOMSound;g.Easing={LINEAR:function(l,k,n,m){return n*l/m+k;},SWING:function(l,k,n,m){return n*(0.5-Math.cos(((l/m)*Math.PI))/2)+k;},QUAD_EASEIN:function(l,k,n,m){return n*(l/=m)*l+k;},QUAD_EASEOUT:function(l,k,n,m){return -n*(l/=m)*(l-2)+k;},QUAD_EASEINOUT:function(l,k,n,m){if((l/=m/2)<1){return n/2*l*l+k;}return -n/2*((--l)*(l-2)-1)+k;},CUBIC_EASEIN:function(l,k,n,m){return n*(l/=m)*l*l+k;},CUBIC_EASEOUT:function(l,k,n,m){return n*((l=l/m-1)*l*l+1)+k;},CUBIC_EASEINOUT:function(l,k,n,m){if((l/=m/2)<1){return n/2*l*l*l+k;}return n/2*((l-=2)*l*l+2)+k;},QUART_EASEIN:function(l,k,n,m){return n*(l/=m)*l*l*l+k;},QUART_EASEOUT:function(l,k,n,m){return -n*((l=l/m-1)*l*l*l-1)+k;},QUART_EASEINOUT:function(l,k,n,m){if((l/=m/2)<1){return n/2*l*l*l*l+k;}return -n/2*((l-=2)*l*l*l-2)+k;},QUINT_EASEIN:function(l,k,n,m){return n*(l/=m)*l*l*l*l+k;},QUINT_EASEOUT:function(l,k,n,m){return n*((l=l/m-1)*l*l*l*l+1)+k;},QUINT_EASEINOUT:function(l,k,n,m){if((l/=m/2)<1){return n/2*l*l*l*l*l+k;}return n/2*((l-=2)*l*l*l*l+2)+k;},SIN_EASEIN:function(l,k,n,m){return -n*Math.cos(l/m*(Math.PI/2))+n+k;},SIN_EASEOUT:function(l,k,n,m){return n*Math.sin(l/m*(Math.PI/2))+k;},SIN_EASEINOUT:function(l,k,n,m){return -n/2*(Math.cos(Math.PI*l/m)-1)+k;},CIRC_EASEIN:function(l,k,n,m){return -n*(Math.sqrt(1-(l/=m)*l)-1)+k;},CIRC_EASEOUT:function(l,k,n,m){return n*Math.sqrt(1-(l=l/m-1)*l)+k;},CIRC_EASEINOUT:function(l,k,n,m){if((l/=m/2)<1){return -n/2*(Math.sqrt(1-l*l)-1)+k;}return n/2*(Math.sqrt(1-(l-=2)*l)+1)+k;},ELASTIC_EASEIN:function(m,k,r,q,l,o){if(m===0){return k;}if((m/=q)===1){return k+r;}if(!o){o=q*0.3;}var n;if(!l||l<Math.abs(r)){l=r;n=o/4;}else{n=o/(2*Math.PI)*Math.asin(r/l);}return -(l*Math.pow(2,10*(m-=1))*Math.sin((m*q-n)*(2*Math.PI)/o))+k;},ELASTIC_EASEOUT:function(m,k,r,q,l,o){if(m===0){return k;}if((m/=q)===1){return k+r;}if(!o){o=q*0.3;}var n;if(!l||l<Math.abs(r)){l=r;n=o/4;}else{n=o/(2*Math.PI)*Math.asin(r/l);}return(l*Math.pow(2,-10*m)*Math.sin((m*q-n)*(2*Math.PI)/o)+r+k);},ELASTIC_EASEINOUT:function(m,k,r,q,l,o){if(m===0){return k;}if((m/=q/2)===2){return k+r;}if(!o){o=q*(0.3*1.5);}var n;if(!l||l<Math.abs(r)){l=r;n=o/4;}else{n=o/(2*Math.PI)*Math.asin(r/l);}if(m<1){return -0.5*(l*Math.pow(2,10*(m-=1))*Math.sin((m*q-n)*(2*Math.PI)/o))+k;}return l*Math.pow(2,-10*(m-=1))*Math.sin((m*q-n)*(2*Math.PI)/o)*0.5+r+k;},BOUNCE_EASEOUT:function(l,k,n,m){if((l/=m)<(1/2.75)){return n*(7.5625*l*l)+k;}else{if(l<(2/2.75)){return n*(7.5625*(l-=(1.5/2.75))*l+0.75)+k;}else{if(l<(2.5/2.75)){return n*(7.5625*(l-=(2.25/2.75))*l+0.9375)+k;}else{return n*(7.5625*(l-=(2.625/2.75))*l+0.984375)+k;}}}},BOUNCE_EASEIN:function(l,k,n,m){return n-g.Easing.BOUNCE_EASEOUT(m-l,0,n,m)+k;},BOUNCE_EASEINOUT:function(l,k,n,m){if(l<m/2){return g.Easing.BOUNCE_EASEIN(l*2,0,n,m)*0.5+k;}else{return g.Easing.BOUNCE_EASEOUT(l*2-m,0,n,m)*0.5+n*0.5+k;}},BACK_EASEIN:function(l,k,o,n,m){if(m===c){m=1.70158;}return o*(l/=n)*l*((m+1)*l-m)+k;},BACK_EASEOUT:function(l,k,o,n,m){if(m===c){m=1.70158;}return o*((l=l/n-1)*l*((m+1)*l+m)+1)+k;},BACK_EASEINOUT:function(l,k,o,n,m){if(m===c){m=1.70158;}if((l/=n/2)<1){return o/2*(l*l*(((m*=(1.525))+1)*l-m))+k;}return o/2*((l-=2)*l*(((m*=(1.525))+1)*l+m)+2)+k;},EXPO_EASEIN:function(l,k,n,m){return(l===0)?k:n*Math.pow(2,10*(l/m-1))+k;},EXPO_EASEOUT:function(l,k,n,m){return(l===m)?k+n:n*(-Math.pow(2,-10*l/m)+1)+k;},EXPO_EASEINOUT:function(l,k,n,m){if(l===0){return k;}if(l===m){return k+n;}if((l/=m/2)<1){return n/2*Math.pow(2,10*(l-1))+k;}return n/2*(-Math.pow(2,-10*--l)+2)+k;}};g.ActionEventTarget=g.Class.create(g.EventTarget,{initialize:function(){g.EventTarget.apply(this,arguments);},dispatchEvent:function(o){var n;if(this.node){n=this.node;o.target=n;o.localX=o.x-n._offsetX;o.localY=o.y-n._offsetY;}else{this.node=null;}if(this["on"+o.type]!=null){this["on"+o.type].call(n,o);}var m=this._listeners[o.type];if(m!=null){m=m.slice();for(var l=0,k=m.length;l<k;l++){m[l].call(n,o);}}}});g.Timeline=g.Class.create(g.EventTarget,{initialize:function(k){g.EventTarget.call(this);this.node=k;this.queue=[];this.paused=false;this.looped=false;this.isFrameBased=true;this._parallel=null;this._activated=false;this.addEventListener(g.Event.ENTER_FRAME,this.tick);},_deactivateTimeline:function(){if(this._activated){this._activated=false;this.node.removeEventListener("enterframe",this._nodeEventListener);}},_activateTimeline:function(){if(!this._activated&&!this.paused){this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true;}},setFrameBased:function(){this.isFrameBased=true;},setTimeBased:function(){this.isFrameBased=false;},next:function(k){var n,m=this.queue.shift();if(m){n=new g.Event("actionend");n.timeline=this;m.dispatchEvent(n);}if(this.queue.length===0){this._activated=false;this.node.removeEventListener("enterframe",this._nodeEventListener);return;}if(this.looped){n=new g.Event("removedfromtimeline");n.timeline=this;m.dispatchEvent(n);m.frame=0;this.add(m);}else{n=new g.Event("removedfromtimeline");n.timeline=this;m.dispatchEvent(n);}if(k>0||(this.queue[0]&&this.queue[0].time===0)){var l=new g.Event("enterframe");l.elapsed=k;this.dispatchEvent(l);}},tick:function(k){if(this.paused){return;}if(this.queue.length>0){var m=this.queue[0];if(m.frame===0){var l;l=new g.Event("actionstart");l.timeline=this;m.dispatchEvent(l);}var n=new g.Event("actiontick");n.timeline=this;if(this.isFrameBased){n.elapsed=1;}else{n.elapsed=k.elapsed;}m.dispatchEvent(n);}},add:function(l){if(!this._activated){var k=this;this._nodeEventListener=function(n){k.dispatchEvent(n);};this.node.addEventListener("enterframe",this._nodeEventListener);this._activated=true;}if(this._parallel){this._parallel.actions.push(l);this._parallel=null;}else{this.queue.push(l);}l.frame=0;var m=new g.Event("addedtotimeline");m.timeline=this;l.dispatchEvent(m);m=new g.Event("actionadded");m.action=l;this.dispatchEvent(m);return this;},action:function(k){return this.add(new g.Action(k));},tween:function(k){return this.add(new g.Tween(k));},clear:function(){var m=new g.Event("removedfromtimeline");m.timeline=this;for(var l=0,k=this.queue.length;l<k;l++){this.queue[l].dispatchEvent(m);}this.queue=[];this._deactivateTimeline();return this;},skip:function(l){var k=new g.Event("enterframe");if(this.isFrameBased){k.elapsed=1;}else{k.elapsed=l;l=1;}while(l--){this.dispatchEvent(k);}return this;},pause:function(){if(!this.paused){this.paused=true;this._deactivateTimeline();}return this;},resume:function(){if(this.paused){this.paused=false;this._activateTimeline();}return this;},loop:function(){this.looped=true;return this;},unloop:function(){this.looped=false;return this;},delay:function(k){this.add(new g.Action({time:k}));return this;},wait:function(k){return this;},then:function(l){var k=this;this.add(new g.Action({onactiontick:function(m){l.call(k.node);},time:0}));return this;},exec:function(k){this.then(k);},cue:function(k){var m=0;for(var l in k){if(k.hasOwnProperty(l)){this.delay(l-m);this.then(k[l]);m=l;}}},repeat:function(k,l){this.add(new g.Action({onactiontick:function(m){k.call(this);},time:l}));return this;},and:function(){var l=this.queue.pop();if(l instanceof g.ParallelAction){this._parallel=l;this.queue.push(l);}else{var k=new g.ParallelAction();k.actions.push(l);this.queue.push(k);this._parallel=k;}return this;},or:function(){return this;},doAll:function(k){return this;},waitAll:function(){return this;},waitUntil:function(l){var k=this;this.add(new g.Action({onactionstart:l,onactiontick:function(m){if(l.call(this)){k.next();}}}));return this;},fadeTo:function(k,l,m){this.tween({opacity:k,time:l,easing:m});return this;},fadeIn:function(k,l){return this.fadeTo(1,k,l);},fadeOut:function(k,l){return this.fadeTo(0,k,l);},moveTo:function(k,n,l,m){return this.tween({x:k,y:n,time:l,easing:m});},moveX:function(k,l,m){return this.tween({x:k,time:l,easing:m});},moveY:function(m,k,l){return this.tween({y:m,time:k,easing:l});},moveBy:function(k,n,l,m){return this.tween({x:function(){return this.x+k;},y:function(){return this.y+n;},time:l,easing:m});},hide:function(){return this.then(function(){this.opacity=0;});},show:function(){return this.then(function(){this.opacity=1;});},removeFromScene:function(){return this.then(function(){this.scene.removeChild(this);});},scaleTo:function(l,k,m){if(typeof m==="number"){return this.tween({scaleX:arguments[0],scaleY:arguments[1],time:arguments[2],easing:arguments[3]});}return this.tween({scaleX:l,scaleY:l,time:k,easing:m});},scaleBy:function(l,k,m){if(typeof m==="number"){return this.tween({scaleX:function(){return this.scaleX*arguments[0];},scaleY:function(){return this.scaleY*arguments[1];},time:arguments[2],easing:arguments[3]});}return this.tween({scaleX:function(){return this.scaleX*l;},scaleY:function(){return this.scaleY*l;},time:k,easing:m});},rotateTo:function(k,l,m){return this.tween({rotation:k,time:l,easing:m});},rotateBy:function(k,l,m){return this.tween({rotation:function(){return this.rotation+k;},time:l,easing:m});}});g.Action=g.Class.create(g.ActionEventTarget,{initialize:function(m){g.ActionEventTarget.call(this);this.time=null;this.frame=0;for(var k in m){if(m.hasOwnProperty(k)){if(m[k]!=null){this[k]=m[k];}}}var l=this;this.timeline=null;this.node=null;this.addEventListener(g.Event.ADDED_TO_TIMELINE,function(n){l.timeline=n.timeline;l.node=n.timeline.node;l.frame=0;});this.addEventListener(g.Event.REMOVED_FROM_TIMELINE,function(){l.timeline=null;l.node=null;l.frame=0;});this.addEventListener(g.Event.ACTION_TICK,function(n){var o=l.time-(l.frame+n.elapsed);if(l.time!=null&&o<=0){l.frame=l.time;n.timeline.next(-o);}else{l.frame+=n.elapsed;}});}});g.ParallelAction=g.Class.create(g.Action,{initialize:function(n){g.Action.call(this,n);var m=this.timeline;var l=this.node;this.actions=[];this.endedActions=[];var k=this;this.addEventListener(g.Event.ACTION_START,function(p){for(var q=0,o=k.actions.length;q<o;q++){k.actions[q].dispatchEvent(p);}});this.addEventListener(g.Event.ACTION_TICK,function(p){var q,o,r={next:function(t){var u=k.actions[q];k.actions.splice(q--,1);o=k.actions.length;k.endedActions.push(u);var v=new g.Event("actionend");v.timeline=this;u.dispatchEvent(v);v=new g.Event("removedfromtimeline");v.timeline=this;u.dispatchEvent(v);}};var s=new g.Event("actiontick");s.timeline=r;s.elapsed=p.elapsed;for(q=0,o=k.actions.length;q<o;q++){k.actions[q].dispatchEvent(s);}if(k.actions.length===0){p.timeline.next();}});this.addEventListener(g.Event.ADDED_TO_TIMELINE,function(p){for(var q=0,o=k.actions.length;q<o;q++){k.actions[q].dispatchEvent(p);}});this.addEventListener(g.Event.REMOVED_FROM_TIMELINE,function(){this.actions=this.endedActions;this.endedActions=[];});}});g.Tween=g.Class.create(g.Action,{initialize:function(n){var k={};var m={};g.Action.call(this,n);if(this.easing==null){this.easing=function(p,o,r,q){return r*p/q+o;};}var l=this;this.addEventListener(g.Event.ACTION_START,function(){var o=["frame","time","callback","onactiontick","onactionstart","onactionend"];for(var q in n){if(n.hasOwnProperty(q)){var p;if(typeof n[q]==="function"){p=n[q].call(l.node);}else{p=n[q];}if(o.indexOf(q)===-1){k[q]=l.node[q];m[q]=p;}}}});this.addEventListener(g.Event.ACTION_TICK,function(o){var p=l.time===0?1:l.easing(Math.min(l.time,l.frame+o.elapsed),0,1,l.time)-l.easing(l.frame,0,1,l.time);for(var q in m){if(m.hasOwnProperty(q)){if(typeof this[q]==="undefined"){continue;}l.node[q]+=(m[q]-k[q])*p;if(Math.abs(l.node[q])<1e-7){l.node[q]=0;}}}});}});}(window));