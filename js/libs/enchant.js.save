(function(e,t){if(typeof Object.defineProperty!=="function"){Object.defineProperty=function(e,t,n){if("value"in n){e[t]=n.value}if("get"in n){e.__defineGetter__(t,n.get)}if("set"in n){e.__defineSetter__(t,n.set)}return e}}if(typeof Object.defineProperties!=="function"){Object.defineProperties=function(e,t){for(var n in t){if(t.hasOwnProperty(n)){Object.defineProperty(e,n,t[n])}}return e}}if(typeof Object.create!=="function"){Object.create=function(e,t){function n(){}n.prototype=e;var r=new n;if(t!=null){Object.defineProperties(r,t)}return r}}if(typeof Object.getPrototypeOf!=="function"){Object.getPrototypeOf=function(e){return e.__proto__}}if(typeof Function.prototype.bind!=="function"){Function.prototype.bind=function(t){var n=this;var r=Array.prototype.slice.call(arguments,1);var i=function(){};var s=function(){var s=r.concat(Array.prototype.slice.call(arguments));return n.apply(this instanceof i?this:t||e,s)};i.prototype=n.prototype;s.prototype=new i;return s}}e.getTime=function(){var t;if(e.performance&&e.performance.now){t=Date.now();return function(){return t+e.performance.now()}}else if(e.performance&&e.performance.webkitNow){t=Date.now();return function(){return t+e.performance.webkitNow()}}else{return Date.now}}();e.requestAnimationFrame=e.requestAnimationFrame||e.mozRequestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame||function(){var t=e.getTime();var n=1e3/60;return function(r){var i=setTimeout(function(){t=e.getTime();r(t)},Math.max(0,t+n-e.getTime()));return i}}();var n=function(t){if(t!=null){if(!(t instanceof Array)){t=Array.prototype.slice.call(arguments)}t=t.filter(function(e){return[e].join()})}(function r(n,i){var s=[],o,u;for(var a in n){if(n.hasOwnProperty(a)){if(typeof n[a]==="function"){e[a]=n[a]}else if(typeof n[a]==="object"&&n[a]!==null&&Object.getPrototypeOf(n[a])===Object.prototype){if(t==null){s.push(a)}else{o=t.indexOf(i+a);if(o!==-1){s.push(a);t.splice(o,1)}}}}}for(o=0,u=s.length;o<u;o++){r(n[s[o]],i+s[o]+".")}})(n,"");if(n.Class.getInheritanceTree(e.Game).length<=n.Class.getInheritanceTree(e.Core).length){e.Game=e.Core}if(t!=null&&t.length){throw new Error("Cannot load module: "+t.join(", "))}};e.enchant=n;e.addEventListener("message",function(e,t){try{var r=JSON.parse(e.data);if(r.type==="event"){n.Core.instance.dispatchEvent(new n.Event(r.value))}else if(r.type==="debug"){switch(r.value){case"start":n.Core.instance.start();break;case"pause":n.Core.instance.pause();break;case"resume":n.Core.instance.resume();break;case"tick":n.Core.instance._tick();break;default:break}}}catch(i){}},false);n.Class=function(e,t){return n.Class.create(e,t)};n.Class.create=function(e,t){if(e==null&&t){throw new Error("superclass is undefined (enchant.Class.create)")}else if(e==null){throw new Error("definition is undefined (enchant.Class.create)")}if(arguments.length===0){return n.Class.create(Object,t)}else if(arguments.length===1&&typeof arguments[0]!=="function"){return n.Class.create(Object,arguments[0])}for(var r in t){if(t.hasOwnProperty(r)){if(typeof t[r]==="object"&&t[r]!==null&&Object.getPrototypeOf(t[r])===Object.prototype){if(!("enumerable"in t[r])){t[r].enumerable=true}}else{t[r]={value:t[r],enumerable:true,writable:true}}}}var i=function(){if(this instanceof i){i.prototype.initialize.apply(this,arguments)}else{return new i}};i.prototype=Object.create(e.prototype,t);i.prototype.constructor=i;if(i.prototype.initialize==null){i.prototype.initialize=function(){e.apply(this,arguments)}}var s=this.getInheritanceTree(e);for(var o=0,u=s.length;o<u;o++){if(typeof s[o]._inherited==="function"){s[o]._inherited(i);break}}return i};n.Class.getInheritanceTree=function(e){var t=[];var n=e;var r=n.prototype;while(n!==Object){t.push(n);r=Object.getPrototypeOf(r);n=r.constructor}return t};n.ENV={VERSION:"0.8.2",BROWSER:function(e){if(/Eagle/.test(e)){return"eagle"}else if(/Opera/.test(e)){return"opera"}else if(/MSIE|Trident/.test(e)){return"ie"}else if(/Chrome/.test(e)){return"chrome"}else if(/(?:Macintosh|Windows).*AppleWebKit/.test(e)){return"safari"}else if(/(?:iPhone|iPad|iPod).*AppleWebKit/.test(e)){return"mobilesafari"}else if(/Firefox/.test(e)){return"firefox"}else if(/Android/.test(e)){return"android"}else{return""}}(navigator.userAgent),VENDOR_PREFIX:function(){var e=navigator.userAgent;if(e.indexOf("Opera")!==-1){return"O"}else if(/MSIE|Trident/.test(e)){return"ms"}else if(e.indexOf("WebKit")!==-1){return"webkit"}else if(navigator.product==="Gecko"){return"Moz"}else{return""}}(),TOUCH_ENABLED:function(){var e=document.createElement("div");e.setAttribute("ontouchstart","return");return typeof e.ontouchstart==="function"}(),RETINA_DISPLAY:function(){if(navigator.userAgent.indexOf("iPhone")!==-1&&e.devicePixelRatio===2){var t=document.querySelector('meta[name="viewport"]');if(t==null){t=document.createElement("meta");document.head.appendChild(t)}t.setAttribute("content","width=640");return true}else{return false}}(),USE_FLASH_SOUND:function(){var e=navigator.userAgent;var t=navigator.vendor||"";return location.href.indexOf("http")===0&&e.indexOf("Mobile")===-1&&t.indexOf("Apple")!==-1}(),USE_DEFAULT_EVENT_TAGS:["input","textarea","select","area"],CANVAS_DRAWING_METHODS:["putImageData","drawImage","drawFocusRing","fill","stroke","clearRect","fillRect","strokeRect","fillText","strokeText"],KEY_BIND_TABLE:{37:"left",38:"up",39:"right",40:"down"},PREVENT_DEFAULT_KEY_CODES:[37,38,39,40,32],SOUND_ENABLED_ON_MOBILE_SAFARI:true,USE_TOUCH_TO_START_SCENE:true,USE_WEBAUDIO:function(){return location.protocol!=="file:"}(),USE_ANIMATION:true};n.Event=n.Class.create({initialize:function(e){this.type=e;this.target=null;this.x=0;this.y=0;this.localX=0;this.localY=0},_initPosition:function(e,t){var r=n.Core.instance;this.x=this.localX=(e-r._pageX)/r.scale;this.y=this.localY=(t-r._pageY)/r.scale}});n.Event.LOAD="load";n.Event.ERROR="error";n.Event.CORE_RESIZE="coreresize";n.Event.PROGRESS="progress";n.Event.ENTER_FRAME="enterframe";n.Event.EXIT_FRAME="exitframe";n.Event.ENTER="enter";n.Event.EXIT="exit";n.Event.CHILD_ADDED="childadded";n.Event.ADDED="added";n.Event.ADDED_TO_SCENE="addedtoscene";n.Event.CHILD_REMOVED="childremoved";n.Event.REMOVED="removed";n.Event.REMOVED_FROM_SCENE="removedfromscene";n.Event.TOUCH_START="touchstart";n.Event.TOUCH_MOVE="touchmove";n.Event.TOUCH_END="touchend";n.Event.RENDER="render";n.Event.INPUT_START="inputstart";n.Event.INPUT_CHANGE="inputchange";n.Event.INPUT_END="inputend";n.Event.INPUT_STATE_CHANGED="inputstatechanged";n.Event.LEFT_BUTTON_DOWN="leftbuttondown";n.Event.LEFT_BUTTON_UP="leftbuttonup";n.Event.RIGHT_BUTTON_DOWN="rightbuttondown";n.Event.RIGHT_BUTTON_UP="rightbuttonup";n.Event.UP_BUTTON_DOWN="upbuttondown";n.Event.UP_BUTTON_UP="upbuttonup";n.Event.DOWN_BUTTON_DOWN="downbuttondown";n.Event.DOWN_BUTTON_UP="downbuttonup";n.Event.A_BUTTON_DOWN="abuttondown";n.Event.A_BUTTON_UP="abuttonup";n.Event.B_BUTTON_DOWN="bbuttondown";n.Event.B_BUTTON_UP="bbuttonup";n.Event.ADDED_TO_TIMELINE="addedtotimeline";n.Event.REMOVED_FROM_TIMELINE="removedfromtimeline";n.Event.ACTION_START="actionstart";n.Event.ACTION_END="actionend";n.Event.ACTION_TICK="actiontick";n.Event.ACTION_ADDED="actionadded";n.Event.ACTION_REMOVED="actionremoved";n.Event.ANIMATION_END="animationend";n.EventTarget=n.Class.create({initialize:function(){this._listeners={}},addEventListener:function(e,t){var n=this._listeners[e];if(n==null){this._listeners[e]=[t]}else if(n.indexOf(t)===-1){n.unshift(t)}},on:function(){this.addEventListener.apply(this,arguments)},removeEventListener:function(e,t){var n=this._listeners[e];if(n!=null){var r=n.indexOf(t);if(r!==-1){n.splice(r,1)}}},clearEventListener:function(e){if(e!=null){delete this._listeners[e]}else{this._listeners={}}},dispatchEvent:function(e){e.target=this;e.localX=e.x-this._offsetX;e.localY=e.y-this._offsetY;if(this["on"+e.type]!=null){this["on"+e.type](e)}var t=this._listeners[e.type];if(t!=null){t=t.slice();for(var n=0,r=t.length;n<r;n++){t[n].call(this,e)}}}});(function(){var t;n.Core=n.Class.create(n.EventTarget,{initialize:function(r,i){if(e.document.body===null){throw new Error("document.body is null. Please excute 'new Core()' in window.onload.")}n.EventTarget.call(this);var s=true;if(t){s=false;t.stop()}t=n.Core.instance=this;this._calledTime=0;this._mousedownID=0;this._surfaceID=0;this._soundID=0;this._scenes=[];r=r||320;i=i||320;var o=document.getElementById("enchant-stage");var u,a,f;if(!o){o=document.createElement("div");o.id="enchant-stage";o.style.position="absolute";if(document.body.firstChild){document.body.insertBefore(o,document.body.firstChild)}else{document.body.appendChild(o)}u=Math.min(e.innerWidth/r,e.innerHeight/i);this._pageX=o.getBoundingClientRect().left;this._pageY=o.getBoundingClientRect().top}else{var l=e.getComputedStyle(o);a=parseInt(l.width,10);f=parseInt(l.height,10);if(a&&f){u=Math.min(a/r,f/i)}else{u=1}while(o.firstChild){o.removeChild(o.firstChild)}o.style.position="relative";var c=o.getBoundingClientRect();this._pageX=Math.round(e.scrollX||e.pageXOffset+c.left);this._pageY=Math.round(e.scrollY||e.pageYOffset+c.top)}o.style.fontSize="12px";o.style.webkitTextSizeAdjust="none";o.style.webkitTapHighlightColor="rgba(0, 0, 0, 0)";this._element=o;this.addEventListener("coreresize",this._oncoreresize);this._width=r;this._height=i;this.scale=u;this.fps=30;this.frame=0;this.ready=false;this.running=false;this.assets={};var h=this._assets=[];(function v(e){if(e.assets){n.Core.instance.preload(e.assets)}for(var t in e){if(e.hasOwnProperty(t)){if(typeof e[t]==="object"&&e[t]!==null&&Object.getPrototypeOf(e[t])===Object.prototype){v(e[t])}}}})(n);this.currentScene=null;this.rootScene=new n.Scene;this.pushScene(this.rootScene);this.loadingScene=new n.LoadingScene;this._activated=false;this._offsetX=0;this._offsetY=0;this.input={};this.keyboardInputManager=new n.KeyboardInputManager(e.document,this.input);this.keyboardInputManager.addBroadcastTarget(this);this._keybind=this.keyboardInputManager._binds;if(!n.ENV.KEY_BIND_TABLE){n.ENV.KEY_BIND_TABLE={}}for(var p in n.ENV.KEY_BIND_TABLE){this.keybind(p,n.ENV.KEY_BIND_TABLE[p])}if(s){o=n.Core.instance._element;var d;document.addEventListener("keydown",function(e){t.dispatchEvent(new n.Event("keydown"));if(n.ENV.PREVENT_DEFAULT_KEY_CODES.indexOf(e.keyCode)!==-1){e.preventDefault();e.stopPropagation()}},true);if(n.ENV.TOUCH_ENABLED){o.addEventListener("touchstart",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);o.addEventListener("touchmove",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);o.addEventListener("touchend",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true)}o.addEventListener("mousedown",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();t._mousedownID++;if(!t.running){e.stopPropagation()}}},true);o.addEventListener("mousemove",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);o.addEventListener("mouseup",function(e){var r=e.target.tagName.toLowerCase();if(n.ENV.USE_DEFAULT_EVENT_TAGS.indexOf(r)===-1){e.preventDefault();if(!t.running){e.stopPropagation()}}},true);t._touchEventTarget={};if(n.ENV.TOUCH_ENABLED){o.addEventListener("touchstart",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_START);var i=e.changedTouches;var s,o;for(var u=0,a=i.length;u<a;u++){s=i[u];r._initPosition(s.pageX,s.pageY);o=t.currentScene._determineEventTarget(r);t._touchEventTarget[s.identifier]=o;o.dispatchEvent(r)}},false);o.addEventListener("touchmove",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_MOVE);var i=e.changedTouches;var s,o;for(var u=0,a=i.length;u<a;u++){s=i[u];o=t._touchEventTarget[s.identifier];if(o){r._initPosition(s.pageX,s.pageY);o.dispatchEvent(r)}}},false);o.addEventListener("touchend",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_END);var i=e.changedTouches;var s,o;for(var u=0,a=i.length;u<a;u++){s=i[u];o=t._touchEventTarget[s.identifier];if(o){r._initPosition(s.pageX,s.pageY);o.dispatchEvent(r);delete t._touchEventTarget[s.identifier]}}},false)}o.addEventListener("mousedown",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_START);r._initPosition(e.pageX,e.pageY);var i=t.currentScene._determineEventTarget(r);t._touchEventTarget[t._mousedownID]=i;i.dispatchEvent(r)},false);o.addEventListener("mousemove",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_MOVE);r._initPosition(e.pageX,e.pageY);var i=t._touchEventTarget[t._mousedownID];if(i){i.dispatchEvent(r)}},false);o.addEventListener("mouseup",function(e){var t=n.Core.instance;var r=new n.Event(n.Event.TOUCH_END);r._initPosition(e.pageX,e.pageY);var i=t._touchEventTarget[t._mousedownID];if(i){i.dispatchEvent(r)}delete t._touchEventTarget[t._mousedownID]},false)}},width:{get:function(){return this._width},set:function(e){this._width=e;this._dispatchCoreResizeEvent()}},height:{get:function(){return this._height},set:function(e){this._height=e;this._dispatchCoreResizeEvent()}},scale:{get:function(){return this._scale},set:function(e){this._scale=e;this._dispatchCoreResizeEvent()}},_dispatchCoreResizeEvent:function(){var e=new n.Event("coreresize");e.width=this._width;e.height=this._height;e.scale=this._scale;this.dispatchEvent(e)},_oncoreresize:function(e){this._element.style.width=Math.floor(this._width*this._scale)+"px";this._element.style.height=Math.floor(this._height*this._scale)+"px";var t;for(var n=0,r=this._scenes.length;n<r;n++){t=this._scenes[n];t.dispatchEvent(e)}},preload:function(e){var t;if(!(e instanceof Array)){if(typeof e==="object"){t=[];for(var n in e){if(e.hasOwnProperty(n)){t.push([e[n],n])}}e=t}else{e=Array.prototype.slice.call(arguments)}}Array.prototype.push.apply(this._assets,e);return this},load:function(e,r,i,s){var o;if(typeof arguments[1]==="string"){o=r;i=i||function(){};s=s||function(){}}else{o=e;var u=i;i=arguments[1]||function(){};s=u||function(){}}var a=n.Core.findExt(e);return n.Deferred.next(function(){var r=new n.Deferred;var u=function(e){r.call(e);i.call(this,e)};var f=function(e){r.fail(e);s.call(this,e)};if(n.Core._loadFuncs[a]){n.Core.instance.assets[o]=n.Core._loadFuncs[a](e,a,u,f)}else{var l=new XMLHttpRequest;l.open("GET",e,true);l.onreadystatechange=function(){if(l.readyState===4){if(l.status!==200&&l.status!==0){var r=new n.Event("error");r.message=l.status+": "+"Cannot load an asset: "+e;f.call(n.Core.instance,r)}var i=l.getResponseHeader("Content-Type")||"";if(i.match(/^image/)){t.assets[o]=n.Surface.load(e,u,f)}else if(i.match(/^audio/)){t.assets[o]=n.Sound.load(e,i,u,f)}else{t.assets[o]=l.responseText;u.call(n.Core.instance,new n.Event("load"))}}};l.send(null)}return r})},start:function(r){var i=function(){this.frame=0;this.removeEventListener("load",i)};this.addEventListener("load",i);this.currentTime=e.getTime();this.running=true;this.ready=true;if(!this._activated){this._activated=true;if(n.ENV.BROWSER==="mobilesafari"&&n.ENV.USE_WEBAUDIO&&n.ENV.USE_TOUCH_TO_START_SCENE){var s=new n.Deferred;var o=this._createTouchToStartScene();o.addEventListener(n.Event.TOUCH_START,function a(){this.removeEventListener(n.Event.TOUCH_START,a);var e=new n.WebAudioSound;e.buffer=n.WebAudioSound.audioContext.createBuffer(1,1,48e3);e.play();t.removeScene(o);t.start(s)},false);t.pushScene(o);return s}}this._requestNextFrame(0);var u=this._requestPreload().next(function(){n.Core.instance.loadingScene.dispatchEvent(new n.Event(n.Event.LOAD))});if(r){u.next(function(e){r.call(e)}).error(function(e){r.fail(e)})}return u},_requestPreload:function(){var e={};var r=0,i=0,s=function(){var e=new n.Event("progress");e.loaded=++r;e.total=i;t.loadingScene.dispatchEvent(e)};this._assets.reverse().forEach(function(t){var n,r;if(t instanceof Array){n=t[0];r=t[1]}else{n=r=t}if(!e[r]){e[r]=this.load(n,r,s);i++}},this);this.pushScene(this.loadingScene);return n.Deferred.parallel(e)},_createTouchToStartScene:function(){var e=new n.Label("Touch to Start"),r=Math.round(t.width/10),i=new n.Scene;e.color="#fff";e.font=r-1+"px bold Helvetica,Arial,sans-serif";e.textAlign="center";e.width=t.width;e.height=e._boundHeight;e.y=(t.height-e.height)/2;i.backgroundColor="#000";i.addChild(e);return i},debug:function(){this._debug=true;return this.start()},actualFps:{get:function(){return this._actualFps||this.fps}},_requestNextFrame:function(t){if(!this.ready){return}if(this.fps>=60||t<=16){this._calledTime=e.getTime();e.requestAnimationFrame(this._callTick)}else{setTimeout(function(){var t=n.Core.instance;t._calledTime=e.getTime();e.requestAnimationFrame(t._callTick)},Math.max(0,t))}},_callTick:function(e){n.Core.instance._tick(e)},_tick:function(t){var r=new n.Event("enterframe");var i=e.getTime();var s=r.elapsed=i-this.currentTime;this._actualFps=s>0?1e3/s:0;var o=this.currentScene.childNodes.slice();var u=Array.prototype.push;while(o.length){var a=o.pop();a.age++;a.dispatchEvent(r);if(a.childNodes){u.apply(o,a.childNodes)}}this.currentScene.age++;this.currentScene.dispatchEvent(r);this.dispatchEvent(r);this.dispatchEvent(new n.Event("exitframe"));this.frame++;i=e.getTime();this.currentTime=i;this._requestNextFrame(1e3/this.fps-(i-this._calledTime))},getTime:function(){return e.getTime()},stop:function(){this.ready=false;this.running=false},pause:function(){this.ready=false},resume:function(){if(this.ready){return}this.currentTime=e.getTime();this.ready=true;this.running=true;this._requestNextFrame(0)},pushScene:function(e){this._element.appendChild(e._element);if(this.currentScene){this.currentScene.dispatchEvent(new n.Event("exit"))}this.currentScene=e;this.currentScene.dispatchEvent(new n.Event("enter"));return this._scenes.push(e)},popScene:function(){if(this.currentScene===this.rootScene){return this.currentScene}this._element.removeChild(this.currentScene._element);this.currentScene.dispatchEvent(new n.Event("exit"));this.currentScene=this._scenes[this._scenes.length-2];this.currentScene.dispatchEvent(new n.Event("enter"));return this._scenes.pop()},replaceScene:function(e){this.popScene();return this.pushScene(e)},removeScene:function(e){if(this.currentScene===e){return this.popScene()}else{var t=this._scenes.indexOf(e);if(t!==-1){this._scenes.splice(t,1);this._element.removeChild(e._element);return e}else{return null}}},_buttonListener:function(e){this.currentScene.dispatchEvent(e)},keybind:function(e,t){this.keyboardInputManager.keybind(e,t);this.addEventListener(t+"buttondown",this._buttonListener);this.addEventListener(t+"buttonup",this._buttonListener);return this},keyunbind:function(e){var t=this._keybind[e];this.keyboardInputManager.keyunbind(e);this.removeEventListener(t+"buttondown",this._buttonListener);this.removeEventListener(t+"buttonup",this._buttonListener);return this},changeButtonState:function(e,t){this.keyboardInputManager.changeState(e,t)},getElapsedTime:function(){return this.frame/this.fps}});n.Core._loadFuncs={};n.Core._loadFuncs["jpg"]=n.Core._loadFuncs["jpeg"]=n.Core._loadFuncs["gif"]=n.Core._loadFuncs["png"]=n.Core._loadFuncs["bmp"]=function(e,t,r,i){return n.Surface.load(e,r,i)};n.Core._loadFuncs["mp3"]=n.Core._loadFuncs["aac"]=n.Core._loadFuncs["m4a"]=n.Core._loadFuncs["wav"]=n.Core._loadFuncs["ogg"]=function(e,t,r,i){return n.Sound.load(e,"audio/"+t,r,i)};n.Core.findExt=function(e){var t=e.match(/\.\w+$/);if(t&&t.length>0){return t[0].slice(1).toLowerCase()}if(e.indexOf("data:")===0){return e.split(/[\/;]/)[1].toLowerCase()}return null};n.Core.instance=null})();n.Game=n.Core;n.InputManager=n.Class.create(n.EventTarget,{initialize:function(e,t){n.EventTarget.call(this);this.broadcastTarget=[];this.valueStore=e;this.source=t||this;this._binds={};this._stateHandler=function(e){var t=e.source.identifier;var n=this._binds[t];this.changeState(n,e.data)}.bind(this)},bind:function(e,t){e.addEventListener(n.Event.INPUT_STATE_CHANGED,this._stateHandler);this._binds[e.identifier]=t},unbind:function(e){e.removeEventListener(n.Event.INPUT_STATE_CHANGED,this._stateHandler);delete this._binds[e.identifier]},addBroadcastTarget:function(e){var t=this.broadcastTarget.indexOf(e);if(t===-1){this.broadcastTarget.push(e)}},removeBroadcastTarget:function(e){var t=this.broadcastTarget.indexOf(e);if(t!==-1){this.broadcastTarget.splice(t,1)}},broadcastEvent:function(e){var t=this.broadcastTarget;for(var n=0,r=t.length;n<r;n++){t[n].dispatchEvent(e)}},changeState:function(e,t){}});n.InputSource=n.Class.create(n.EventTarget,{initialize:function(e){n.EventTarget.call(this);this.identifier=e},notifyStateChange:function(e){var t=new n.Event(n.Event.INPUT_STATE_CHANGED);t.data=e;t.source=this;this.dispatchEvent(t)}});n.BinaryInputManager=n.Class.create(n.InputManager,{initialize:function(e,t,r,i){n.InputManager.call(this,e,i);this.activeInputsNum=0;this.activeEventNameSuffix=t;this.inactiveEventNameSuffix=r},bind:function(e,t){n.InputManager.prototype.bind.call(this,e,t);this.valueStore[t]=false},unbind:function(e){var t=this._binds[e.identifier];n.InputManager.prototype.unbind.call(this,e);delete this.valueStore[t]},changeState:function(e,t){if(t){this._down(e)}else{this._up(e)}},_down:function(e){var t;if(!this.valueStore[e]){this.valueStore[e]=true;t=new n.Event(this.activeInputsNum++?"inputchange":"inputstart");t.source=this.source;this.broadcastEvent(t)}var r=new n.Event(e+this.activeEventNameSuffix);r.source=this.source;this.broadcastEvent(r)},_up:function(e){var t;if(this.valueStore[e]){this.valueStore[e]=false;t=new n.Event(--this.activeInputsNum?"inputchange":"inputend");t.source=this.source;this.broadcastEvent(t)}var r=new n.Event(e+this.inactiveEventNameSuffix);r.source=this.source;this.broadcastEvent(r)}});n.BinaryInputSource=n.Class.create(n.InputSource,{initialize:function(e){n.InputSource.call(this,e)}});n.KeyboardInputManager=n.Class.create(n.BinaryInputManager,{initialize:function(e,t){n.BinaryInputManager.call(this,t,"buttondown","buttonup");this._attachDOMEvent(e,"keydown",true);this._attachDOMEvent(e,"keyup",false)},keybind:function(e,t){this.bind(n.KeyboardInputSource.getByKeyCode(""+e),t)},keyunbind:function(e){this.unbind(n.KeyboardInputSource.getByKeyCode(""+e))},_attachDOMEvent:function(e,t,r){e.addEventListener(t,function(e){var t=n.Core.instance;if(!t||!t.running){return}var i=e.keyCode;var s=n.KeyboardInputSource._instances[i];if(s){s.notifyStateChange(r)}},true)}});n.KeyboardInputSource=n.Class.create(n.BinaryInputSource,{initialize:function(e){n.BinaryInputSource.call(this,e)}});n.KeyboardInputSource._instances={};n.KeyboardInputSource.getByKeyCode=function(e){if(!this._instances[e]){this._instances[e]=new n.KeyboardInputSource(e)}return this._instances[e]};n.Node=n.Class.create(n.EventTarget,{initialize:function(){n.EventTarget.call(this);this._dirty=false;this._matrix=[1,0,0,1,0,0];this._x=0;this._y=0;this._offsetX=0;this._offsetY=0;this.age=0;this.parentNode=null;this.scene=null;this.addEventListener("touchstart",function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});this.addEventListener("touchmove",function(e){if(this.parentNode){this.parentNode.dispatchEvent(e)}});this.addEventListener("touchend",function(e){if(this.parentNode){this.parentNode.dispatchEv
